<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafe POS System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .receipt-paper { 
            width: 80mm; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            line-height: 1.2; 
        }
        @media print {
            .no-print { display: none; }
            .receipt-paper { width: 100%; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-purple-700">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">‚òï Cafe POS</h1>
                <p class="text-gray-600">Please sign in to continue</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter username" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="password" class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter password" required>
                        <button type="button" onclick="togglePasswordVisibility()" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 transition-colors">
                            <svg id="eyeIcon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <svg id="eyeOffIcon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />
                            </svg>
                        </button>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Main POS Interface -->
    <div id="posInterface" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-gray-800">‚òï Cafe POS</h1>
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium" id="userRole">Staff</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-center">
                        <span class="text-gray-600 block" id="currentUser">Welcome, User</span>
                        <span class="text-xs text-gray-500" id="shiftStatus">No Active Shift</span>
                    </div>
                    <div class="text-center">
                        <div class="text-sm font-semibold text-blue-600" id="realTimeDate"></div>
                        <div class="text-xs text-gray-500" id="realTimeTime"></div>
                    </div>
                    <button onclick="showShiftManagement()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">üïê Shift</button>
                    <button onclick="showReports()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">üìä Reports</button>
                    <button onclick="showSettings()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition" id="settingsBtn">‚öôÔ∏è Settings</button>
                    <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Logout</button>
                </div>
            </div>
        </header>

        <div class="flex h-screen">
            <!-- Menu Categories & Items -->
            <div class="w-1/2 p-6 overflow-y-auto">
                <!-- Categories -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Menu Categories</h2>
                        <button onclick="showAddCategory()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition" id="addCategoryBtn" style="display:none;">+ Add Category</button>
                    </div>
                    <div id="categoriesContainer" class="flex flex-wrap gap-3 mb-6">
                        <!-- Categories will be populated here -->
                    </div>
                </div>

                <!-- Menu Items -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Menu Items</h2>
                        <button onclick="showAddItem()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition" id="addItemBtn" style="display:none;">+ Add Item</button>
                    </div>
                    <div id="menuItemsContainer" class="grid grid-cols-2 gap-4">
                        <!-- Menu items will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Order Summary & Checkout -->
            <div class="w-1/2 bg-white border-l border-gray-200 p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Current Order</h2>
                    <span class="bg-gray-100 px-3 py-1 rounded-lg text-sm font-medium" id="receiptNumber">Receipt #001</span>
                </div>

                <!-- Order Items -->
                <div id="orderItems" class="space-y-3 mb-6 max-h-64 overflow-y-auto">
                    <!-- Order items will appear here -->
                </div>

                <!-- Discount Section -->
                <div class="mb-6 p-6 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold text-gray-700 mb-4 text-lg">Discount</h3>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <button onclick="applyDiscount(10)" class="bg-blue-500 text-white px-3 py-3 rounded hover:bg-blue-600 transition text-sm font-medium">10% Off</button>
                        <button onclick="applyDiscount(20)" class="bg-green-500 text-white px-3 py-3 rounded hover:bg-green-600 transition text-sm font-medium">20% Off</button>
                        <button onclick="applyDiscount(50)" class="bg-orange-500 text-white px-3 py-3 rounded hover:bg-orange-600 transition text-sm font-medium">50% Off</button>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="applyDiscount(100)" class="bg-red-500 text-white px-4 py-3 rounded hover:bg-red-600 transition text-sm font-medium">100% Off</button>
                        <button onclick="showCustomDiscount()" class="bg-purple-500 text-white px-4 py-3 rounded hover:bg-purple-600 transition text-sm font-medium">Custom</button>
                        <button onclick="removeDiscount()" class="bg-gray-500 text-white px-4 py-3 rounded hover:bg-gray-600 transition text-sm font-medium">Remove</button>
                    </div>
                </div>

                <!-- Order Total -->
                <div class="border-t border-gray-200 pt-4 mb-6">
                    <div class="flex justify-between text-lg font-semibold">
                        <span>Total:</span>
                        <span id="orderTotal">$0.00</span>
                    </div>
                    <div id="discountInfo" class="text-sm text-green-600 mt-1" style="display:none;"></div>
                </div>

                <!-- Payment Buttons -->
                <div class="space-y-3">
                    <button onclick="processPayment('Cash')" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-medium">üíµ Pay with Cash</button>
                    <button onclick="processPayment('QRCode')" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-medium">üì± Pay with QR Code</button>
                    <button onclick="showVoidReceipt()" class="w-full bg-orange-600 text-white py-3 rounded-lg hover:bg-orange-700 transition font-medium">üóëÔ∏è Void Receipt ID</button>
                </div>


            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="addItemModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-96 max-h-96 overflow-y-auto">
            <h3 class="text-xl font-semibold mb-4">Add New Item</h3>
            <form id="addItemForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
                    <input type="text" id="itemName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select id="itemCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        <!-- Categories will be populated -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
                    <input type="number" id="itemPrice" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Item Image</label>
                    <div class="space-y-2">
                        <input type="file" id="itemImageFile" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <div id="imagePreview" class="hidden">
                            <img id="previewImg" class="w-20 h-20 object-cover rounded-lg border" alt="Preview">
                        </div>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Add Item</button>
                    <button type="button" onclick="closeModal('addItemModal')" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-96">
            <h3 class="text-xl font-semibold mb-4">Add New Category</h3>
            <form id="addCategoryForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category Name</label>
                    <input type="text" id="categoryName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Add Category</button>
                    <button type="button" onclick="closeModal('addCategoryModal')" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Sugar Options Modal -->
    <div id="sugarModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-80">
            <h3 class="text-xl font-semibold mb-4">Sugar Options</h3>
            <div class="space-y-3">
                <button onclick="selectSugarOption('No Sugar')" class="w-full bg-blue-100 text-blue-800 py-3 rounded-lg hover:bg-blue-200 transition">üö´ No Sugar</button>
                <button onclick="selectSugarOption('Normal')" class="w-full bg-green-100 text-green-800 py-3 rounded-lg hover:bg-green-200 transition">‚úÖ Normal</button>
                <button onclick="selectSugarOption('Sweet')" class="w-full bg-yellow-100 text-yellow-800 py-3 rounded-lg hover:bg-yellow-200 transition">üçØ Sweet</button>
            </div>
            <button onclick="closeModal('sugarModal')" class="w-full mt-4 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">Cancel</button>
        </div>
    </div>

    <!-- Quantity Selection Modal -->
    <div id="quantityModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-80">
            <h3 class="text-xl font-semibold mb-4">Select Quantity</h3>
            
            <!-- Item Info -->
            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                <p class="font-medium" id="quantityItemName">Item Name</p>
                <p class="text-sm text-gray-600" id="quantityItemPrice">$0.00 each</p>
                <p class="text-sm text-blue-600" id="quantityItemSugar">Sugar option</p>
            </div>
            
            <!-- Quantity Controls -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                <div class="flex items-center justify-center space-x-4">
                    <button onclick="changeQuantity(-1)" class="bg-red-500 text-white w-10 h-10 rounded-full hover:bg-red-600 transition font-bold text-lg">-</button>
                    <span class="text-2xl font-bold w-12 text-center" id="selectedQuantity">1</span>
                    <button onclick="changeQuantity(1)" class="bg-green-500 text-white w-10 h-10 rounded-full hover:bg-green-600 transition font-bold text-lg">+</button>
                </div>
                
                <!-- Quick quantity buttons -->
                <div class="grid grid-cols-5 gap-2 mt-4">
                    <button onclick="setQuantity(1)" class="bg-gray-100 text-gray-800 py-2 rounded hover:bg-gray-200 transition text-sm">1</button>
                    <button onclick="setQuantity(2)" class="bg-gray-100 text-gray-800 py-2 rounded hover:bg-gray-200 transition text-sm">2</button>
                    <button onclick="setQuantity(3)" class="bg-gray-100 text-gray-800 py-2 rounded hover:bg-gray-200 transition text-sm">3</button>
                    <button onclick="setQuantity(5)" class="bg-gray-100 text-gray-800 py-2 rounded hover:bg-gray-200 transition text-sm">5</button>
                    <button onclick="setQuantity(10)" class="bg-gray-100 text-gray-800 py-2 rounded hover:bg-gray-200 transition text-sm">10</button>
                </div>
            </div>
            
            <!-- Total Price Display -->
            <div class="mb-4 p-3 bg-green-50 rounded-lg">
                <div class="flex justify-between items-center">
                    <span class="text-green-700">Total Price:</span>
                    <span class="text-xl font-bold text-green-800" id="totalItemPrice">$0.00</span>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="space-y-3">
                <button onclick="confirmAddToOrder()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-medium">Add to Order</button>
                <button onclick="closeModal('quantityModal')" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Reports Modal -->
    <div id="reportsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl w-11/12 max-w-7xl h-5/6 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Sales Reports</h3>
                <button onclick="closeModal('reportsModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <!-- Report Filters -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="flex gap-3">
                    <select id="paymentFilter" class="px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="all">All Payments</option>
                        <option value="Cash">Cash Only</option>
                        <option value="QRCode">QR Code Only</option>
                    </select>
                    <select id="reportType" class="px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="dashboard">üìä Dashboard</option>
                        <option value="transactions">Transaction Report</option>
                        <option value="items">Item Sales Report</option>
                        <option value="summary">Summary Report</option>
                        <option value="void">Void Report</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <input type="date" id="startDate" class="px-3 py-2 border border-gray-300 rounded-lg">
                    <input type="date" id="endDate" class="px-3 py-2 border border-gray-300 rounded-lg">
                    <button onclick="generateReportsTable()" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 transition">üîç Filter</button>
                </div>
            </div>
            
            <!-- Quick Date Filters -->
            <div class="flex gap-2 mb-4">
                <button onclick="setDateFilter('today')" class="bg-gray-100 text-gray-700 px-3 py-1 rounded hover:bg-gray-200 transition text-sm">Today</button>
                <button onclick="setDateFilter('yesterday')" class="bg-gray-100 text-gray-700 px-3 py-1 rounded hover:bg-gray-200 transition text-sm">Yesterday</button>
                <button onclick="setDateFilter('week')" class="bg-gray-100 text-gray-700 px-3 py-1 rounded hover:bg-gray-200 transition text-sm">This Week</button>
                <button onclick="setDateFilter('month')" class="bg-gray-100 text-gray-700 px-3 py-1 rounded hover:bg-gray-200 transition text-sm">This Month</button>
                <button onclick="setDateFilter('all')" class="bg-gray-100 text-gray-700 px-3 py-1 rounded hover:bg-gray-200 transition text-sm">All Time</button>
                <button onclick="exportToExcel()" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition text-sm ml-auto">üìä Export</button>
            </div>

            <!-- Reports Table -->
            <div id="reportsTable" class="flex-1 overflow-auto">
                <!-- Reports will be populated here -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-4/5 max-w-2xl max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Admin Settings</h3>
                <button onclick="closeModal('settingsModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <div class="grid grid-cols-2 gap-6">
                <!-- User Management -->
                <div>
                    <h4 class="font-semibold mb-3">User Management</h4>
                    <div class="space-y-2">
                        <button onclick="showCreateUser()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">üë§ Create User</button>
                        <button onclick="showManageUsers()" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition">üóëÔ∏è Manage Users</button>
                    </div>
                </div>

                <!-- Data Management -->
                <div>
                    <h4 class="font-semibold mb-3">Data Management</h4>
                    <div class="space-y-2">
                        <button onclick="backupData()" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition">üíæ Backup Data</button>
                        <button onclick="restoreData()" class="w-full bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition">üîÑ Restore Data</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-96">
            <h3 class="text-xl font-semibold mb-4">Create New User</h3>
            <form id="createUserForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="newUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="newPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select id="newUserRole" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        <option value="staff">Staff</option>
                        <option value="manager">Manager</option>
                        <option value="sysadmin">System Administrator</option>
                    </select>
                </div>

                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Create User</button>
                    <button type="button" onclick="closeModal('createUserModal')" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Users Modal -->
    <div id="manageUsersModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-4/5 max-w-4xl max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-red-600">üóëÔ∏è Manage Users</h3>
                <button onclick="closeModal('manageUsersModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <div class="mb-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                <p class="text-yellow-800 text-sm">
                    <strong>‚ö†Ô∏è Warning:</strong> Deleting a user will permanently remove their account. This action cannot be undone.
                </p>
            </div>
            
            <div id="usersTable">
                <!-- Users table will be populated here -->
            </div>
        </div>
    </div>

    <!-- Custom Discount Modal -->
    <div id="customDiscountModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-80">
            <h3 class="text-xl font-semibold mb-4">Custom Discount</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Discount Percentage</label>
                    <input type="number" id="customDiscountPercent" min="0" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter percentage">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fixed Amount Discount ($)</label>
                    <input type="number" id="customDiscountAmount" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter fixed amount">
                </div>
            </div>
            <div class="flex gap-3 mt-4">
                <button onclick="applyCustomDiscount()" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition">Apply</button>
                <button onclick="closeModal('customDiscountModal')" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Void Confirmation Modal -->
    <div id="voidModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-96">
            <h3 class="text-xl font-semibold mb-4 text-red-600">Void Order Confirmation</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Void:</label>
                    <select id="voidReason" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        <option value="">Select a reason...</option>
                        <option value="Customer Request">Customer Request</option>
                        <option value="Wrong Order">Wrong Order</option>
                        <option value="Payment Issue">Payment Issue</option>
                        <option value="Item Unavailable">Item Unavailable</option>
                        <option value="Staff Error">Staff Error</option>
                        <option value="System Error">System Error</option>
                        <option value="Manager Override">Manager Override</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div id="customReasonDiv" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Custom Reason:</label>
                    <input type="text" id="customReason" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter custom reason">
                </div>
                

                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes (Optional):</label>
                    <textarea id="voidNotes" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="2" placeholder="Any additional notes..."></textarea>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="confirmVoid()" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition">Confirm Void</button>
                <button onclick="closeModal('voidModal')" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Void Receipt Modal -->
    <div id="voidReceiptModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-4/5 max-w-4xl max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-red-600">Void Receipt by ID</h3>
                <button onclick="closeModal('voidReceiptModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <!-- Search Receipt -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                <label class="block text-sm font-medium text-gray-700 mb-2">Enter Receipt Number to Void:</label>
                <div class="flex gap-3">
                    <input type="text" id="receiptSearchInput" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" placeholder="e.g., 001, 025, 100">
                    <button onclick="searchReceipt()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Search</button>
                </div>
            </div>

            <!-- Receipt Details -->
            <div id="receiptDetails" class="hidden mb-4 p-4 border border-gray-300 rounded-lg">
                <!-- Receipt details will be populated here -->
            </div>

            <!-- Available Receipts Table -->
            <div class="mb-4">
                <h4 class="font-semibold mb-2">Available Receipts (Click to Select):</h4>
                <div id="availableReceipts" class="max-h-48 overflow-y-auto">
                    <!-- Available receipts will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Invoice Modal -->
    <div id="receiptInvoiceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-96 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-green-600">Payment Successful!</h3>
                <button onclick="closeModal('receiptInvoiceModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <!-- Receipt Display -->
            <div id="receiptDisplay" class="bg-gray-50 p-4 rounded-lg mb-4 font-mono text-sm">
                <!-- Receipt content will be generated here -->
            </div>
            
            <!-- Action Buttons -->
            <div class="space-y-3">
                <button onclick="printReceipt()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">üñ®Ô∏è Print Receipt</button>
                <button onclick="closeModal('receiptInvoiceModal')" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">Close</button>
            </div>
        </div>
    </div>

    <!-- Receipt Void Reason Modal -->
    <div id="receiptVoidReasonModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-96">
            <h3 class="text-xl font-semibold mb-4 text-red-600">Void Receipt Confirmation</h3>
            
            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-600">Receipt to void:</p>
                <p class="font-semibold" id="receiptToVoidDisplay">Receipt #000</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Void:</label>
                    <select id="receiptVoidReason" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        <option value="">Select a reason...</option>
                        <option value="Customer Request">Customer Request</option>
                        <option value="Wrong Order">Wrong Order</option>
                        <option value="Payment Issue">Payment Issue</option>
                        <option value="Item Unavailable">Item Unavailable</option>
                        <option value="Staff Error">Staff Error</option>
                        <option value="System Error">System Error</option>
                        <option value="Manager Override">Manager Override</option>
                        <option value="Refund Request">Refund Request</option>
                        <option value="Duplicate Transaction">Duplicate Transaction</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div id="receiptCustomReasonDiv" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Custom Reason:</label>
                    <input type="text" id="receiptCustomReason" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter custom reason">
                </div>
                

                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes (Optional):</label>
                    <textarea id="receiptVoidNotes" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="2" placeholder="Any additional notes..."></textarea>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="confirmReceiptVoidWithReason()" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition">Confirm Void</button>
                <button onclick="closeModal('receiptVoidReasonModal')" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Shift Management Modal -->
    <div id="shiftModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-4/5 max-w-4xl max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-purple-600">üïê Shift Management</h3>
                <button onclick="closeModal('shiftModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <!-- Current Shift Status -->
            <div id="currentShiftInfo" class="mb-6 p-4 bg-purple-50 rounded-lg">
                <!-- Shift info will be populated here -->
            </div>
            
            <!-- Shift Actions -->
            <div class="grid grid-cols-2 gap-6 mb-6">
                <div class="space-y-3">
                    <h4 class="font-semibold text-gray-700">Shift Actions</h4>
                    <button onclick="startShift()" id="startShiftBtn" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-medium">üü¢ Start Shift</button>
                    <button onclick="endShift()" id="endShiftBtn" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition font-medium" disabled>üî¥ End Shift</button>
                </div>
                <div class="space-y-3">
                    <h4 class="font-semibold text-gray-700">Receipt Management</h4>
                    <div class="flex gap-2">
                        <input type="number" id="receiptStartNumber" min="1" max="1000" value="1" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" placeholder="Start #">
                        <button onclick="setReceiptRange()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Set Range</button>
                    </div>
                    <div class="text-sm text-gray-600">
                        <p>Current Receipt: <span id="currentReceiptDisplay" class="font-semibold">#001</span></p>
                        <p>Daily Range: <span id="receiptRangeDisplay" class="font-semibold">001-1000</span></p>
                    </div>
                </div>
            </div>
            
            <!-- Shift History -->
            <div>
                <h4 class="font-semibold text-gray-700 mb-3">Recent Shifts</h4>
                <div id="shiftHistory" class="max-h-48 overflow-y-auto">
                    <!-- Shift history will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- License Info Modal -->
    <div id="licenseInfoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-96">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-green-600">üìã License Information</h3>
                <button onclick="closeModal('licenseInfoModal')" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <div id="licenseDetails" class="space-y-4">
                <!-- License details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Extend License Modal -->
    <div id="extendLicenseModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-96">
            <h3 class="text-xl font-semibold mb-4 text-yellow-600">‚è∞ Extend License</h3>
            
            <form id="extendLicenseForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Extension Period</label>
                    <select id="extensionPeriod" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        <option value="">Select extension period...</option>
                        <option value="30">30 Days</option>
                        <option value="90">90 Days (3 Months)</option>
                        <option value="180">180 Days (6 Months)</option>
                        <option value="365">365 Days (1 Year)</option>
                        <option value="custom">Custom Period</option>
                    </select>
                </div>
                
                <div id="customPeriodDiv" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Custom Days</label>
                    <input type="number" id="customDays" min="1" max="3650" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter number of days">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">License Key (Optional)</label>
                    <input type="text" id="licenseKey" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter license key if available">
                </div>
                
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-yellow-600 text-white py-2 rounded-lg hover:bg-yellow-700 transition">Extend License</button>
                    <button type="button" onclick="closeModal('extendLicenseModal')" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Receipt Print Area -->
    <div id="receiptPrint" class="hidden">
        <div class="receipt-paper">
            <div style="text-align: center; margin-bottom: 10px;">
                <h2>‚òï CAFE POS</h2>
                <p>Thank you for your visit!</p>
                <hr>
            </div>
            <div id="receiptContent">
                <!-- Receipt content will be generated here -->
            </div>
            <div style="text-align: center; margin-top: 10px;">
                <hr>
                <p>WiFi: CafeGuest | Password: coffee123</p>
                <p>Have a great day!</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentOrder = [];
        let receiptCounter = 1;
        let currentItem = null;
        let currentSugarOption = null;
        let selectedQuantity = 1;
        let discountPercent = 0;
        let currentTransaction = null;
        let currentShift = null;
        let realTimeInterval = null;

        // Database simulation using localStorage
        const db = {
            users: JSON.parse(localStorage.getItem('pos_users') || '[]'),
            categories: JSON.parse(localStorage.getItem('pos_categories') || '[]'),
            items: JSON.parse(localStorage.getItem('pos_items') || '[]'),
            transactions: JSON.parse(localStorage.getItem('pos_transactions') || '[]'),
            voidTransactions: JSON.parse(localStorage.getItem('pos_void_transactions') || '[]'),
            shifts: JSON.parse(localStorage.getItem('pos_shifts') || '[]'),
            systemSettings: JSON.parse(localStorage.getItem('pos_system_settings') || '{}'),
            license: JSON.parse(localStorage.getItem('pos_license') || '{}')
        };

        // Initialize default data
        function initializeDefaultData() {
            if (db.users.length === 0) {
                db.users = [
                    { id: 1, username: 'sysadmin', password: 'sysadmin123', role: 'sysadmin' },
                    { id: 2, username: 'manager', password: 'manager123', role: 'manager' },
                    { id: 3, username: 'staff', password: 'staff123', role: 'staff' }
                ];
                saveToStorage('pos_users', db.users);
            }

            // Initialize license system
            if (!db.license.expiryDate) {
                const defaultExpiry = new Date();
                defaultExpiry.setDate(defaultExpiry.getDate() + 30); // 30 days trial
                db.license = {
                    expiryDate: defaultExpiry.toISOString(),
                    isActive: true,
                    licenseType: 'trial'
                };
                saveToStorage('pos_license', db.license);
            }

            if (db.categories.length === 0) {
                db.categories = [
                    { id: 1, name: 'Coffee' },
                    { id: 2, name: 'Tea' },
                    { id: 3, name: 'Pastries' },
                    { id: 4, name: 'Sandwiches' }
                ];
                saveToStorage('pos_categories', db.categories);
            }

            if (db.items.length === 0) {
                db.items = [
                    { id: 1, name: 'Espresso', category: 'Coffee', price: 3.50, image: '' },
                    { id: 2, name: 'Cappuccino', category: 'Coffee', price: 4.25, image: '' },
                    { id: 3, name: 'Latte', category: 'Coffee', price: 4.75, image: '' },
                    { id: 4, name: 'Green Tea', category: 'Tea', price: 2.50, image: '' },
                    { id: 5, name: 'Croissant', category: 'Pastries', price: 3.00, image: '' },
                    { id: 6, name: 'Club Sandwich', category: 'Sandwiches', price: 8.50, image: '' }
                ];
                saveToStorage('pos_items', db.items);
            }
        }

        function saveToStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        // Authentication
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const user = db.users.find(u => u.username === username && u.password === password);
            if (user) {
                // Check license based on user role before allowing login
                if (!checkLicenseForUser(user.role)) {
                    return;
                }
                
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('posInterface').classList.remove('hidden');
                document.getElementById('currentUser').textContent = `Welcome, ${user.username}`;
                document.getElementById('userRole').textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1);
                
                // Show/hide features based on role
                setupRolePermissions(user.role);
                
                // Initialize systems
                loadCategories();
                loadMenuItems();
                initializeShiftSystem();
                startRealTimeClock();
                updateShiftStatus();
                
                // Show license warning for expired license (SysAdmin only)
                showLicenseWarningIfNeeded(user.role);
            } else {
                alert('Invalid username or password');
            }
        });

        // License Management Functions
        function checkLicense() {
            const now = new Date();
            const expiryDate = new Date(db.license.expiryDate);
            
            if (now > expiryDate) {
                alert('‚ö†Ô∏è LICENSE EXPIRED\n\nYour POS system license has expired.\nPlease contact your System Administrator to renew the license.\n\nSystem access is restricted until license renewal.');
                return false;
            }
            
            // Check if license expires within 7 days
            const daysUntilExpiry = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
            if (daysUntilExpiry <= 7 && daysUntilExpiry > 0) {
                alert(`‚ö†Ô∏è LICENSE EXPIRING SOON\n\nYour license will expire in ${daysUntilExpiry} day(s).\nPlease contact your System Administrator to extend the license.`);
            }
            
            return true;
        }

        function checkLicenseForUser(userRole) {
            const now = new Date();
            const expiryDate = new Date(db.license.expiryDate);
            
            if (now > expiryDate) {
                if (userRole === 'sysadmin') {
                    // SysAdmin can still access to manage license
                    const allowAccess = confirm('‚ö†Ô∏è LICENSE EXPIRED\n\nYour POS system license has expired.\nAs System Administrator, you can still access the system to extend the license.\n\nClick OK to continue with limited access, or Cancel to logout.');
                    return allowAccess;
                } else {
                    // Manager and Staff are completely locked out
                    alert('‚ö†Ô∏è LICENSE EXPIRED\n\nYour POS system license has expired.\nManager and Staff access is restricted until license renewal.\n\nPlease contact your System Administrator to extend the license.');
                    return false;
                }
            }
            
            // Check if license expires within 7 days
            const daysUntilExpiry = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
            if (daysUntilExpiry <= 7 && daysUntilExpiry > 0) {
                if (userRole === 'sysadmin') {
                    alert(`‚ö†Ô∏è LICENSE EXPIRING SOON\n\nYour license will expire in ${daysUntilExpiry} day(s).\nAs System Administrator, please extend the license soon.`);
                } else {
                    alert(`‚ö†Ô∏è LICENSE EXPIRING SOON\n\nYour license will expire in ${daysUntilExpiry} day(s).\nPlease contact your System Administrator to extend the license.`);
                }
            }
            
            return true;
        }

        function setupRolePermissions(role) {
            // Hide all admin features first
            document.getElementById('addCategoryBtn').style.display = 'none';
            document.getElementById('addItemBtn').style.display = 'none';
            document.getElementById('settingsBtn').style.display = 'none';
            
            // Check if license is expired
            const now = new Date();
            const expiryDate = new Date(db.license.expiryDate);
            const isLicenseExpired = now > expiryDate;
            
            switch(role) {
                case 'sysadmin':
                    // SysAdmin has access to everything including license management
                    document.getElementById('addCategoryBtn').style.display = 'block';
                    document.getElementById('addItemBtn').style.display = 'block';
                    document.getElementById('settingsBtn').style.display = 'block';
                    break;
                case 'manager':
                    // Manager can add items, categories, view reports, create users (only if license is active)
                    if (!isLicenseExpired) {
                        document.getElementById('addCategoryBtn').style.display = 'block';
                        document.getElementById('addItemBtn').style.display = 'block';
                        document.getElementById('settingsBtn').style.display = 'block';
                    }
                    break;
                case 'staff':
                    // Staff can only process orders (only if license is active)
                    break;
            }
        }

        function showLicenseWarningIfNeeded(userRole) {
            const now = new Date();
            const expiryDate = new Date(db.license.expiryDate);
            const isLicenseExpired = now > expiryDate;
            
            if (isLicenseExpired && userRole === 'sysadmin') {
                // Show persistent warning for SysAdmin with expired license
                setTimeout(() => {
                    const warningDiv = document.createElement('div');
                    warningDiv.id = 'licenseWarningBanner';
                    warningDiv.className = 'fixed top-0 left-0 right-0 bg-red-600 text-white p-3 text-center z-50 shadow-lg';
                    warningDiv.innerHTML = `
                        <div class="flex items-center justify-center space-x-4">
                            <span class="text-lg">‚ö†Ô∏è LICENSE EXPIRED - Limited Access Mode</span>
                            <button onclick="showExtendLicense()" class="bg-white text-red-600 px-4 py-1 rounded hover:bg-gray-100 transition font-medium">Extend License</button>
                            <button onclick="closeLicenseWarning()" class="text-white hover:text-gray-200 transition">‚úï</button>
                        </div>
                    `;
                    document.body.appendChild(warningDiv);
                    
                    // Adjust main content to account for warning banner
                    document.getElementById('posInterface').style.marginTop = '60px';
                }, 1000);
            }
        }

        function closeLicenseWarning() {
            const warningBanner = document.getElementById('licenseWarningBanner');
            if (warningBanner) {
                warningBanner.remove();
                document.getElementById('posInterface').style.marginTop = '0';
            }
        }

        function logout() {
            // End active shift if exists
            if (currentShift) {
                const confirmEndShift = confirm('You have an active shift. Do you want to end it before logging out?');
                if (confirmEndShift) {
                    endShift();
                }
            }
            
            // Stop real-time clock
            stopRealTimeClock();
            
            // Reset variables
            currentUser = null;
            currentOrder = [];
            currentShift = null;
            
            // Show login screen
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('posInterface').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Categories
        function loadCategories() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';
            
            db.categories.forEach(category => {
                const categoryBtn = document.createElement('button');
                categoryBtn.className = 'bg-blue-100 text-blue-800 px-4 py-2 rounded-lg hover:bg-blue-200 transition';
                categoryBtn.textContent = category.name;
                categoryBtn.onclick = () => filterByCategory(category.name);
                container.appendChild(categoryBtn);
            });

            // Add "All" button
            const allBtn = document.createElement('button');
            allBtn.className = 'bg-gray-100 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-200 transition';
            allBtn.textContent = 'All';
            allBtn.onclick = () => loadMenuItems();
            container.insertBefore(allBtn, container.firstChild);
        }

        function showAddCategory() {
            if (currentUser.role !== 'manager' && currentUser.role !== 'sysadmin') {
                alert('Access denied. Manager or SysAdmin privileges required.');
                return;
            }
            
            // Check license for Manager users
            if (currentUser.role === 'manager') {
                const now = new Date();
                const expiryDate = new Date(db.license.expiryDate);
                if (now > expiryDate) {
                    alert('‚ö†Ô∏è LICENSE EXPIRED\n\nManager functions are disabled due to expired license.\nPlease contact your System Administrator to extend the license.');
                    return;
                }
            }
            
            document.getElementById('addCategoryModal').classList.remove('hidden');
        }

        document.getElementById('addCategoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('categoryName').value;
            
            const newCategory = {
                id: Date.now(),
                name: name
            };
            
            db.categories.push(newCategory);
            saveToStorage('pos_categories', db.categories);
            loadCategories();
            populateCategorySelect();
            closeModal('addCategoryModal');
            document.getElementById('categoryName').value = '';
        });

        // Menu Items
        function loadMenuItems(categoryFilter = null) {
            const container = document.getElementById('menuItemsContainer');
            container.innerHTML = '';
            
            let items = db.items;
            if (categoryFilter) {
                items = items.filter(item => item.category === categoryFilter);
            }
            
            items.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'bg-white p-10 rounded-lg shadow-md hover:shadow-lg transition cursor-pointer border border-gray-200 min-h-80 relative';
                itemCard.innerHTML = `
                    ${currentUser && currentUser.role === 'admin' ? `
                    <button onclick="event.stopPropagation(); deleteMenuItem(${item.id})" class="absolute top-2 right-2 bg-red-500 text-white w-8 h-8 rounded-full hover:bg-red-600 transition flex items-center justify-center text-sm font-bold" title="Delete Item">√ó</button>
                    ` : ''}
                    <div class="text-center">
                        ${item.image ? `<img src="${item.image}" alt="${item.name}" class="w-32 h-32 mx-auto mb-4 rounded-lg object-cover" onerror="this.style.display='none';">` : '<div class="w-32 h-32 mx-auto mb-4 bg-gray-200 rounded-lg flex items-center justify-center text-5xl">‚òï</div>'}
                        <h3 class="font-semibold text-gray-800 mb-2 text-lg">${item.name}</h3>
                        <p class="text-sm text-gray-600 mb-2">${item.category}</p>
                        <p class="text-xl font-bold text-green-600">$${item.price.toFixed(2)}</p>
                    </div>
                `;
                itemCard.onclick = () => selectItem(item);
                container.appendChild(itemCard);
            });
        }

        function filterByCategory(category) {
            loadMenuItems(category);
        }

        function deleteMenuItem(itemId) {
            if (currentUser.role !== 'manager' && currentUser.role !== 'sysadmin') {
                alert('Access denied. Manager or SysAdmin privileges required.');
                return;
            }
            
            const item = db.items.find(i => i.id === itemId);
            if (!item) {
                alert('Item not found');
                return;
            }
            
            const confirmDelete = confirm(`Are you sure you want to delete "${item.name}"?\n\nThis action cannot be undone.`);
            if (confirmDelete) {
                // Remove item from database
                db.items = db.items.filter(i => i.id !== itemId);
                saveToStorage('pos_items', db.items);
                
                // Reload menu items display
                loadMenuItems();
                
                alert(`"${item.name}" has been deleted successfully.`);
            }
        }

        function selectItem(item) {
            currentItem = item;
            selectedQuantity = 1; // Reset quantity
            
            // Show sugar options for drinks
            if (item.category === 'Coffee' || item.category === 'Tea') {
                document.getElementById('sugarModal').classList.remove('hidden');
            } else {
                // For non-drinks, go directly to quantity selection
                currentSugarOption = 'N/A';
                showQuantityModal();
            }
        }

        function selectSugarOption(sugarOption) {
            currentSugarOption = sugarOption;
            closeModal('sugarModal');
            showQuantityModal();
        }

        function showQuantityModal() {
            // Update item info in quantity modal
            document.getElementById('quantityItemName').textContent = currentItem.name;
            document.getElementById('quantityItemPrice').textContent = `$${currentItem.price.toFixed(2)} each`;
            document.getElementById('quantityItemSugar').textContent = currentSugarOption !== 'N/A' ? currentSugarOption : 'No sugar option';
            
            // Reset and update quantity display
            document.getElementById('selectedQuantity').textContent = selectedQuantity;
            updateTotalPrice();
            
            document.getElementById('quantityModal').classList.remove('hidden');
        }

        function changeQuantity(change) {
            selectedQuantity = Math.max(1, selectedQuantity + change);
            document.getElementById('selectedQuantity').textContent = selectedQuantity;
            updateTotalPrice();
        }

        function setQuantity(quantity) {
            selectedQuantity = quantity;
            document.getElementById('selectedQuantity').textContent = selectedQuantity;
            updateTotalPrice();
        }

        function updateTotalPrice() {
            const totalPrice = currentItem.price * selectedQuantity;
            document.getElementById('totalItemPrice').textContent = `$${totalPrice.toFixed(2)}`;
        }

        function confirmAddToOrder() {
            addToOrder(currentItem, currentSugarOption, selectedQuantity);
            closeModal('quantityModal');
        }

        function showAddItem() {
            if (currentUser.role !== 'manager' && currentUser.role !== 'sysadmin') {
                alert('Access denied. Manager or SysAdmin privileges required.');
                return;
            }
            
            // Check license for Manager users
            if (currentUser.role === 'manager') {
                const now = new Date();
                const expiryDate = new Date(db.license.expiryDate);
                if (now > expiryDate) {
                    alert('‚ö†Ô∏è LICENSE EXPIRED\n\nManager functions are disabled due to expired license.\nPlease contact your System Administrator to extend the license.');
                    return;
                }
            }
            
            populateCategorySelect();
            document.getElementById('addItemModal').classList.remove('hidden');
        }

        function populateCategorySelect() {
            const select = document.getElementById('itemCategory');
            select.innerHTML = '';
            db.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }

        // Image handling for items
        document.getElementById('itemImageFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    const previewImg = document.getElementById('previewImg');
                    previewImg.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });



        document.getElementById('addItemForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('itemName').value;
            const category = document.getElementById('itemCategory').value;
            const price = parseFloat(document.getElementById('itemPrice').value);
            
            // Get image from file only
            let imageData = '';
            const fileInput = document.getElementById('itemImageFile');
            
            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageData = e.target.result;
                    saveNewItem();
                };
                reader.readAsDataURL(fileInput.files[0]);
                return; // Wait for file reading to complete
            }
            
            saveNewItem();
            
            function saveNewItem() {
                const newItem = {
                    id: Date.now(),
                    name: name,
                    category: category,
                    price: price,
                    image: imageData
                };
                
                db.items.push(newItem);
                saveToStorage('pos_items', db.items);
                loadMenuItems();
                closeModal('addItemModal');
                document.getElementById('addItemForm').reset();
                document.getElementById('imagePreview').classList.add('hidden');
            }
        });

        // Order Management
        function addToOrder(item, sugarOption, quantity = 1) {
            // Check if item with same sugar option already exists
            const existingItem = currentOrder.find(oi => oi.name === item.name && oi.sugarOption === sugarOption);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                const orderItem = {
                    id: Date.now(),
                    name: item.name,
                    price: item.price,
                    sugarOption: sugarOption,
                    quantity: quantity
                };
                currentOrder.push(orderItem);
            }
            
            updateOrderDisplay();
        }

        function removeFromOrder(itemId) {
            currentOrder = currentOrder.filter(item => item.id !== itemId);
            updateOrderDisplay();
        }

        function updateOrderDisplay() {
            const container = document.getElementById('orderItems');
            container.innerHTML = '';
            
            if (currentOrder.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No items in order</p>';
            } else {
                currentOrder.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                    itemDiv.innerHTML = `
                        <div class="flex-1">
                            <h4 class="font-medium">${item.name}</h4>
                            <p class="text-sm text-gray-600">${item.sugarOption !== 'N/A' ? item.sugarOption : ''}</p>
                            <div class="flex items-center space-x-2 mt-2">
                                <button onclick="changeOrderItemQuantity(${item.id}, -1)" class="bg-red-500 text-white w-6 h-6 rounded-full hover:bg-red-600 transition text-xs font-bold">-</button>
                                <span class="text-sm font-medium w-8 text-center">${item.quantity}</span>
                                <button onclick="changeOrderItemQuantity(${item.id}, 1)" class="bg-green-500 text-white w-6 h-6 rounded-full hover:bg-green-600 transition text-xs font-bold">+</button>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold">$${(item.price * item.quantity).toFixed(2)}</p>
                            <button onclick="removeFromOrder(${item.id})" class="text-red-500 hover:text-red-700 text-sm">Remove</button>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });
            }
            
            updateTotal();
        }

        function changeOrderItemQuantity(itemId, change) {
            const item = currentOrder.find(i => i.id === itemId);
            if (item) {
                item.quantity = Math.max(1, item.quantity + change);
                updateOrderDisplay();
            }
        }

        function updateTotal() {
            const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let discountAmount = 0;
            
            if (discountType === 'percentage') {
                discountAmount = subtotal * (discountPercent / 100);
            } else if (discountType === 'fixed') {
                discountAmount = Math.min(discountValue, subtotal); // Don't exceed subtotal
            }
            
            const total = Math.max(0, subtotal - discountAmount);
            
            document.getElementById('orderTotal').textContent = `$${total.toFixed(2)}`;
            
            const discountInfo = document.getElementById('discountInfo');
            if (discountAmount > 0) {
                discountInfo.style.display = 'block';
                if (discountType === 'percentage') {
                    discountInfo.textContent = `Discount ${discountPercent}%: -$${discountAmount.toFixed(2)}`;
                } else {
                    discountInfo.textContent = `Fixed Discount: -$${discountAmount.toFixed(2)}`;
                }
            } else {
                discountInfo.style.display = 'none';
            }
        }

        // Discount Functions
        let discountType = 'percentage'; // 'percentage' or 'fixed'
        let discountValue = 0;

        function applyDiscount(percent) {
            discountType = 'percentage';
            discountPercent = percent;
            discountValue = percent;
            updateTotal();
        }

        function showCustomDiscount() {
            document.getElementById('customDiscountModal').classList.remove('hidden');
        }

        function applyCustomDiscount() {
            const percentInput = document.getElementById('customDiscountPercent').value;
            const amountInput = document.getElementById('customDiscountAmount').value;
            
            if (percentInput && parseFloat(percentInput) > 0) {
                discountType = 'percentage';
                discountPercent = parseFloat(percentInput);
                discountValue = parseFloat(percentInput);
            } else if (amountInput && parseFloat(amountInput) > 0) {
                discountType = 'fixed';
                discountPercent = 0;
                discountValue = parseFloat(amountInput);
            } else {
                alert('Please enter a valid discount amount');
                return;
            }
            
            updateTotal();
            closeModal('customDiscountModal');
            document.getElementById('customDiscountPercent').value = '';
            document.getElementById('customDiscountAmount').value = '';
        }

        function removeDiscount() {
            discountType = 'percentage';
            discountPercent = 0;
            discountValue = 0;
            updateTotal();
        }

        // Payment Processing
        function processPayment(paymentType) {
            if (currentOrder.length === 0) {
                alert('No items in order');
                return;
            }
            
            if (!currentShift) {
                alert('Please start a shift before processing transactions');
                return;
            }
            
            const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let discountAmount = 0;
            
            if (discountType === 'percentage') {
                discountAmount = subtotal * (discountPercent / 100);
            } else if (discountType === 'fixed') {
                discountAmount = Math.min(discountValue, subtotal);
            }
            
            const total = Math.max(0, subtotal - discountAmount);
            
            const transaction = {
                id: Date.now(),
                receiptNumber: String(receiptCounter).padStart(3, '0'),
                items: [...currentOrder],
                subtotal: subtotal,
                discount: discountAmount,
                total: total,
                paymentType: paymentType,
                timestamp: new Date().toISOString(),
                cashier: currentUser.username
            };
            
            db.transactions.push(transaction);
            saveToStorage('pos_transactions', db.transactions);
            
            // Store current transaction for receipt display
            currentTransaction = transaction;
            
            // Show receipt invoice modal
            showReceiptInvoice(transaction);
            
            // Reset order
            currentOrder = [];
            discountPercent = 0;
            discountType = 'percentage';
            discountValue = 0;
            updateOrderDisplay();
            updateReceiptNumber();
        }

        function showReceiptInvoice(transaction) {
            const receiptDisplay = document.getElementById('receiptDisplay');
            receiptDisplay.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 18px;">‚òï CAFE POS</h3>
                    <p style="margin: 5px 0; font-size: 12px;">Thank you for your visit!</p>
                    <hr style="margin: 10px 0;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <p style="margin: 2px 0;"><strong>Receipt #:</strong> ${transaction.receiptNumber}</p>
                    <p style="margin: 2px 0;"><strong>Date:</strong> ${new Date(transaction.timestamp).toLocaleString()}</p>
                    <p style="margin: 2px 0;"><strong>Cashier:</strong> ${transaction.cashier}</p>
                    <p style="margin: 2px 0;"><strong>Payment:</strong> ${transaction.paymentType}</p>
                </div>
                
                <hr style="margin: 10px 0;">
                
                <div style="margin-bottom: 15px;">
                    ${transaction.items.map(item => `
                        <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                            <span style="flex: 1;">${item.name} ${item.sugarOption !== 'N/A' ? '(' + item.sugarOption + ')' : ''}</span>
                            <span style="margin: 0 10px;">x${item.quantity}</span>
                            <span style="font-weight: bold;">$${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
                
                <hr style="margin: 10px 0;">
                
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                        <span>Subtotal:</span>
                        <span>$${transaction.subtotal.toFixed(2)}</span>
                    </div>
                    ${transaction.discount > 0 ? `
                    <div style="display: flex; justify-content: space-between; margin: 3px 0; color: #059669;">
                        <span>Discount:</span>
                        <span>-$${transaction.discount.toFixed(2)}</span>
                    </div>
                    ` : ''}
                    <div style="display: flex; justify-content: space-between; margin: 8px 0; font-weight: bold; font-size: 16px; border-top: 1px solid #ccc; padding-top: 5px;">
                        <span>TOTAL:</span>
                        <span>$${transaction.total.toFixed(2)}</span>
                    </div>
                </div>
                
                <hr style="margin: 10px 0;">
                
                <div style="text-align: center; font-size: 12px; color: #666;">
                    <p style="margin: 5px 0;">WiFi: CafeGuest | Password: coffee123</p>
                    <p style="margin: 5px 0;">Have a great day!</p>
                </div>
            `;
            
            document.getElementById('receiptInvoiceModal').classList.remove('hidden');
        }

        function printReceipt() {
            if (!currentTransaction) {
                alert('No receipt to print');
                return;
            }
            
            const receiptContent = document.getElementById('receiptContent');
            receiptContent.innerHTML = `
                <p>Receipt #: ${currentTransaction.receiptNumber}</p>
                <p>Date: ${new Date(currentTransaction.timestamp).toLocaleString()}</p>
                <p>Cashier: ${currentTransaction.cashier}</p>
                <hr>
                ${currentTransaction.items.map(item => `
                    <div style="display: flex; justify-content: space-between;">
                        <span>${item.name} ${item.sugarOption !== 'N/A' ? '(' + item.sugarOption + ')' : ''} x${item.quantity}</span>
                        <span>$${(item.price * item.quantity).toFixed(2)}</span>
                    </div>
                `).join('')}
                <hr>
                <div style="display: flex; justify-content: space-between;">
                    <span>Subtotal:</span>
                    <span>$${currentTransaction.subtotal.toFixed(2)}</span>
                </div>
                ${currentTransaction.discount > 0 ? `
                <div style="display: flex; justify-content: space-between;">
                    <span>Discount:</span>
                    <span>-$${currentTransaction.discount.toFixed(2)}</span>
                </div>
                ` : ''}
                <div style="display: flex; justify-content: space-between; font-weight: bold;">
                    <span>Total:</span>
                    <span>$${currentTransaction.total.toFixed(2)}</span>
                </div>
                <p>Payment: ${currentTransaction.paymentType}</p>
                <hr>
                <p style="text-align: center;">WiFi: CafeGuest | Password: coffee123</p>
            `;
            
            // Show print area and trigger print
            const printArea = document.getElementById('receiptPrint');
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
            
            console.log('Receipt printed for transaction:', currentTransaction.receiptNumber);
        }



        function updateReceiptNumber() {
            receiptCounter = receiptCounter >= 1000 ? 1 : receiptCounter + 1;
            
            // Save to system settings
            db.systemSettings.receiptCounter = receiptCounter;
            saveToStorage('pos_system_settings', db.systemSettings);
            
            updateReceiptDisplays();
        }

        // Void Functions
        function voidOrder() {
            if (currentOrder.length === 0) {
                alert('No items to void');
                return;
            }
            document.getElementById('voidModal').classList.remove('hidden');
        }

        function showVoidReceipt() {
            document.getElementById('voidReceiptModal').classList.remove('hidden');
            loadAvailableReceipts();
        }

        function loadAvailableReceipts() {
            const container = document.getElementById('availableReceipts');
            const availableTransactions = db.transactions.filter(t => 
                !db.voidTransactions.some(v => v.originalReceiptNumber === t.receiptNumber)
            );
            
            if (availableTransactions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No receipts available to void</p>';
                return;
            }
            
            const tableHTML = `
                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-4 py-2">Receipt #</th>
                            <th class="border border-gray-300 px-4 py-2">Date</th>
                            <th class="border border-gray-300 px-4 py-2">Total</th>
                            <th class="border border-gray-300 px-4 py-2">Payment</th>
                            <th class="border border-gray-300 px-4 py-2">Cashier</th>
                            <th class="border border-gray-300 px-4 py-2">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${availableTransactions.map(t => `
                            <tr class="hover:bg-gray-50 cursor-pointer" onclick="selectReceiptForVoid('${t.receiptNumber}')">
                                <td class="border border-gray-300 px-4 py-2 font-semibold">${t.receiptNumber}</td>
                                <td class="border border-gray-300 px-4 py-2">${new Date(t.timestamp).toLocaleDateString()}</td>
                                <td class="border border-gray-300 px-4 py-2">$${t.total.toFixed(2)}</td>
                                <td class="border border-gray-300 px-4 py-2">${t.paymentType}</td>
                                <td class="border border-gray-300 px-4 py-2">${t.cashier}</td>
                                <td class="border border-gray-300 px-4 py-2">
                                    <button onclick="event.stopPropagation(); selectReceiptForVoid('${t.receiptNumber}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 transition text-sm">Select</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        function searchReceipt() {
            const receiptNumber = document.getElementById('receiptSearchInput').value.trim();
            if (!receiptNumber) {
                alert('Please enter a receipt number');
                return;
            }
            
            // Pad receipt number to 3 digits if needed
            const paddedReceiptNumber = receiptNumber.padStart(3, '0');
            
            const transaction = db.transactions.find(t => t.receiptNumber === paddedReceiptNumber);
            const isAlreadyVoided = db.voidTransactions.some(v => v.originalReceiptNumber === paddedReceiptNumber);
            
            const detailsContainer = document.getElementById('receiptDetails');
            
            if (!transaction) {
                detailsContainer.innerHTML = `
                    <div class="text-red-600">
                        <h4 class="font-semibold">Receipt Not Found</h4>
                        <p>Receipt #${paddedReceiptNumber} was not found in the system.</p>
                    </div>
                `;
                detailsContainer.classList.remove('hidden');
                return;
            }
            
            if (isAlreadyVoided) {
                detailsContainer.innerHTML = `
                    <div class="text-orange-600">
                        <h4 class="font-semibold">Receipt Already Voided</h4>
                        <p>Receipt #${paddedReceiptNumber} has already been voided and cannot be voided again.</p>
                    </div>
                `;
                detailsContainer.classList.remove('hidden');
                return;
            }
            
            detailsContainer.innerHTML = `
                <div class="bg-white">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-green-600">Receipt Found - Ready to Void</h4>
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">Available</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <p><strong>Receipt #:</strong> ${transaction.receiptNumber}</p>
                            <p><strong>Date:</strong> ${new Date(transaction.timestamp).toLocaleString()}</p>
                            <p><strong>Cashier:</strong> ${transaction.cashier}</p>
                            <p><strong>Payment:</strong> ${transaction.paymentType}</p>
                        </div>
                        <div>
                            <p><strong>Subtotal:</strong> $${transaction.subtotal.toFixed(2)}</p>
                            <p><strong>Discount:</strong> $${transaction.discount.toFixed(2)}</p>
                            <p><strong>Total:</strong> $${transaction.total.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h5 class="font-medium mb-2">Items:</h5>
                        <div class="bg-gray-50 p-3 rounded">
                            ${transaction.items.map(item => `
                                <div class="flex justify-between">
                                    <span>${item.name} ${item.sugarOption !== 'N/A' ? '(' + item.sugarOption + ')' : ''} x${item.quantity}</span>
                                    <span>$${(item.price * item.quantity).toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <button onclick="showReceiptVoidReason('${transaction.receiptNumber}')" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition font-medium">
                        Proceed to Void This Receipt
                    </button>
                </div>
            `;
            detailsContainer.classList.remove('hidden');
        }

        let selectedReceiptForVoid = null;

        function selectReceiptForVoid(receiptNumber) {
            const transaction = db.transactions.find(t => t.receiptNumber === receiptNumber);
            if (!transaction) {
                alert('Receipt not found');
                return;
            }
            
            const isAlreadyVoided = db.voidTransactions.some(v => v.originalReceiptNumber === receiptNumber);
            if (isAlreadyVoided) {
                alert('This receipt has already been voided');
                return;
            }
            
            selectedReceiptForVoid = transaction;
            closeModal('voidReceiptModal');
            
            // Show confirmation without staff ID
            const confirmVoid = confirm(`Are you sure you want to void Receipt #${receiptNumber} for $${transaction.total.toFixed(2)}?`);
            if (confirmVoid) {
                confirmReceiptVoid();
            }
        }

        function showReceiptVoidReason(receiptNumber) {
            const transaction = db.transactions.find(t => t.receiptNumber === receiptNumber);
            if (!transaction) {
                alert('Receipt not found');
                return;
            }
            
            const isAlreadyVoided = db.voidTransactions.some(v => v.originalReceiptNumber === receiptNumber);
            if (isAlreadyVoided) {
                alert('This receipt has already been voided');
                return;
            }
            
            selectedReceiptForVoid = transaction;
            document.getElementById('receiptToVoidDisplay').textContent = `Receipt #${receiptNumber} - $${transaction.total.toFixed(2)}`;
            closeModal('voidReceiptModal');
            document.getElementById('receiptVoidReasonModal').classList.remove('hidden');
        }

        function confirmReceiptVoidWithReason() {
            const voidReason = document.getElementById('receiptVoidReason').value;
            const customReason = document.getElementById('receiptCustomReason').value;
            const voidNotes = document.getElementById('receiptVoidNotes').value;
            
            if (!selectedReceiptForVoid) {
                alert('No receipt selected for void');
                return;
            }
            
            if (!voidReason) {
                alert('Please select a reason for void');
                return;
            }
            
            if (voidReason === 'Other' && !customReason) {
                alert('Please enter a custom reason');
                return;
            }
            
            const finalReason = voidReason === 'Other' ? customReason : voidReason;
            
            const voidTransaction = {
                id: Date.now(),
                receiptNumber: String(receiptCounter).padStart(3, '0'),
                originalReceiptNumber: selectedReceiptForVoid.receiptNumber,
                items: [...selectedReceiptForVoid.items],
                subtotal: selectedReceiptForVoid.subtotal,
                discount: selectedReceiptForVoid.discount,
                total: selectedReceiptForVoid.total,
                voidedBy: currentUser.username,
                voidId: currentUser.username,
                timestamp: new Date().toISOString(),
                reason: finalReason,
                notes: voidNotes,
                voidType: 'Receipt Void',
                originalTransaction: selectedReceiptForVoid
            };
            
            db.voidTransactions.push(voidTransaction);
            saveToStorage('pos_void_transactions', db.voidTransactions);
            
            updateReceiptNumber();
            closeModal('receiptVoidReasonModal');
            
            // Clear form
            document.getElementById('receiptVoidReason').value = '';
            document.getElementById('receiptCustomReason').value = '';
            document.getElementById('receiptVoidNotes').value = '';
            document.getElementById('receiptCustomReasonDiv').classList.add('hidden');
            
            selectedReceiptForVoid = null;
            
            alert(`Receipt #${voidTransaction.originalReceiptNumber} has been successfully voided!\nReason: ${finalReason}\nVoid Receipt #${voidTransaction.receiptNumber} generated.`);
        }

        function confirmReceiptVoid() {
            if (!selectedReceiptForVoid) {
                alert('No receipt selected for void');
                return;
            }
            
            const voidTransaction = {
                id: Date.now(),
                receiptNumber: String(receiptCounter).padStart(3, '0'),
                originalReceiptNumber: selectedReceiptForVoid.receiptNumber,
                items: [...selectedReceiptForVoid.items],
                subtotal: selectedReceiptForVoid.subtotal,
                discount: selectedReceiptForVoid.discount,
                total: selectedReceiptForVoid.total,
                voidedBy: currentUser.username,
                voidId: currentUser.username,
                timestamp: new Date().toISOString(),
                reason: 'Receipt void by ID',
                voidType: 'Receipt Void',
                originalTransaction: selectedReceiptForVoid
            };
            
            db.voidTransactions.push(voidTransaction);
            saveToStorage('pos_void_transactions', db.voidTransactions);
            
            updateReceiptNumber();
            selectedReceiptForVoid = null;
            
            alert(`Receipt #${voidTransaction.originalReceiptNumber} has been successfully voided!\nVoid Receipt #${voidTransaction.receiptNumber} generated.`);
        }

        function confirmVoid() {
            const voidReason = document.getElementById('voidReason').value;
            const customReason = document.getElementById('customReason').value;
            const voidNotes = document.getElementById('voidNotes').value;
            
            if (!voidReason) {
                alert('Please select a reason for void');
                return;
            }
            
            if (voidReason === 'Other' && !customReason) {
                alert('Please enter a custom reason');
                return;
            }
            
            const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let discountAmount = 0;
            
            if (discountType === 'percentage') {
                discountAmount = subtotal * (discountPercent / 100);
            } else if (discountType === 'fixed') {
                discountAmount = Math.min(discountValue, subtotal);
            }
            
            const total = Math.max(0, subtotal - discountAmount);
            
            const finalReason = voidReason === 'Other' ? customReason : voidReason;
            
            const voidTransaction = {
                id: Date.now(),
                receiptNumber: String(receiptCounter).padStart(3, '0'),
                items: [...currentOrder],
                subtotal: subtotal,
                discount: discountAmount,
                total: total,
                voidedBy: currentUser.username,
                voidId: currentUser.username,
                timestamp: new Date().toISOString(),
                reason: finalReason,
                notes: voidNotes,
                voidType: 'Current Order'
            };
            
            db.voidTransactions.push(voidTransaction);
            saveToStorage('pos_void_transactions', db.voidTransactions);
            
            currentOrder = [];
            discountPercent = 0;
            discountType = 'percentage';
            discountValue = 0;
            updateOrderDisplay();
            closeModal('voidModal');
            
            // Clear form
            document.getElementById('voidReason').value = '';
            document.getElementById('customReason').value = '';
            document.getElementById('voidNotes').value = '';
            document.getElementById('customReasonDiv').classList.add('hidden');
            
            alert(`Order voided successfully!\nReason: ${finalReason}\nVoid Receipt #${voidTransaction.receiptNumber}`);
        }

        // Reports
        function showReports() {
            // Allow all user roles to view reports
            // Check license for Manager and Staff users (SysAdmin can always access)
            if (currentUser.role === 'manager' || currentUser.role === 'staff') {
                const now = new Date();
                const expiryDate = new Date(db.license.expiryDate);
                if (now > expiryDate) {
                    alert('‚ö†Ô∏è LICENSE EXPIRED\n\nReport functions are disabled due to expired license.\nPlease contact your System Administrator to extend the license.');
                    return;
                }
            }
            
            document.getElementById('reportsModal').classList.remove('hidden');
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            
            // Set dashboard as default
            document.getElementById('reportType').value = 'dashboard';
            generateReportsTable();
        }

        function setDateFilter(period) {
            const today = new Date();
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            
            switch(period) {
                case 'today':
                    const todayStr = today.toISOString().split('T')[0];
                    startDate.value = todayStr;
                    endDate.value = todayStr;
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    startDate.value = yesterdayStr;
                    endDate.value = yesterdayStr;
                    break;
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    startDate.value = weekStart.toISOString().split('T')[0];
                    endDate.value = today.toISOString().split('T')[0];
                    break;
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    startDate.value = monthStart.toISOString().split('T')[0];
                    endDate.value = today.toISOString().split('T')[0];
                    break;
                case 'all':
                    startDate.value = '';
                    endDate.value = '';
                    break;
            }
            generateReportsTable();
        }

        function generateReportsTable() {
            const reportType = document.getElementById('reportType').value;
            
            switch(reportType) {
                case 'dashboard':
                    generateDashboardReport();
                    break;
                case 'transactions':
                    generateTransactionReport();
                    break;
                case 'items':
                    generateItemSalesReport();
                    break;
                case 'summary':
                    generateSummaryReport();
                    break;
                case 'void':
                    showVoidReport();
                    break;
            }
        }

        function generateDashboardReport() {
            const paymentFilter = document.getElementById('paymentFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let transactions = db.transactions;
            
            // Filter by payment type
            if (paymentFilter !== 'all') {
                transactions = transactions.filter(t => t.paymentType === paymentFilter);
            }
            
            // Filter by date range
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                
                transactions = transactions.filter(t => {
                    const transactionDate = new Date(t.timestamp);
                    return transactionDate >= start && transactionDate <= end;
                });
            }
            
            // Calculate metrics
            const totalRevenue = transactions.reduce((sum, t) => sum + t.total, 0);
            const totalSubtotal = transactions.reduce((sum, t) => sum + t.subtotal, 0);
            const totalDiscounts = transactions.reduce((sum, t) => sum + t.discount, 0);
            const cashTransactions = transactions.filter(t => t.paymentType === 'Cash');
            const qrTransactions = transactions.filter(t => t.paymentType === 'QRCode');
            
            // Item analysis
            const itemSales = {};
            const categorySales = {};
            const hourlySales = {};
            
            transactions.forEach(t => {
                // Hourly sales analysis
                const hour = new Date(t.timestamp).getHours();
                const hourKey = `${hour}:00`;
                if (!hourlySales[hourKey]) {
                    hourlySales[hourKey] = { transactions: 0, revenue: 0 };
                }
                hourlySales[hourKey].transactions += 1;
                hourlySales[hourKey].revenue += t.total;
                
                t.items.forEach(item => {
                    const itemName = item.name;
                    if (!itemSales[itemName]) {
                        itemSales[itemName] = { quantity: 0, revenue: 0, transactions: 0 };
                    }
                    itemSales[itemName].quantity += item.quantity;
                    itemSales[itemName].revenue += item.price * item.quantity;
                    itemSales[itemName].transactions += 1;
                    
                    // Find category for this item
                    const menuItem = db.items.find(mi => mi.name === itemName);
                    if (menuItem) {
                        const category = menuItem.category;
                        if (!categorySales[category]) {
                            categorySales[category] = { quantity: 0, revenue: 0, transactions: 0 };
                        }
                        categorySales[category].quantity += item.quantity;
                        categorySales[category].revenue += item.price * item.quantity;
                        categorySales[category].transactions += 1;
                    }
                });
            });
            
            // Sort data
            const topItems = Object.entries(itemSales)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);
            
            const topCategories = Object.entries(categorySales)
                .sort((a, b) => b[1].revenue - a[1].revenue);
            
            const peakHours = Object.entries(hourlySales)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);
            
            const dashboardHTML = `
                <!-- Key Metrics Cards -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="p-4 bg-gradient-to-r from-green-400 to-green-600 text-white rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm">Total Revenue</p>
                                <p class="text-2xl font-bold">$${totalRevenue.toFixed(2)}</p>
                            </div>
                            <div class="text-3xl opacity-80">üí∞</div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gradient-to-r from-blue-400 to-blue-600 text-white rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm">Total Transactions</p>
                                <p class="text-2xl font-bold">${transactions.length}</p>
                            </div>
                            <div class="text-3xl opacity-80">üßæ</div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gradient-to-r from-purple-400 to-purple-600 text-white rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm">Average Sale</p>
                                <p class="text-2xl font-bold">$${transactions.length > 0 ? (totalRevenue / transactions.length).toFixed(2) : '0.00'}</p>
                            </div>
                            <div class="text-3xl opacity-80">üìä</div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gradient-to-r from-orange-400 to-orange-600 text-white rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm">Total Discounts</p>
                                <p class="text-2xl font-bold">$${totalDiscounts.toFixed(2)}</p>
                            </div>
                            <div class="text-3xl opacity-80">üè∑Ô∏è</div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts and Analytics -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <!-- Sales Bar Chart -->
                    <div class="p-4 bg-white rounded-lg shadow border">
                        <h4 class="font-semibold text-gray-800 mb-4">üìä Top Items Sales Chart</h4>
                        <div class="space-y-3">
                            ${topItems.length > 0 ? (() => {
                                const maxRevenue = Math.max(...topItems.map(item => item[1].revenue));
                                return topItems.slice(0, 5).map((item, index) => {
                                    const percentage = maxRevenue > 0 ? (item[1].revenue / maxRevenue) * 100 : 0;
                                    const colors = ['bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-red-500'];
                                    return `
                                        <div class="mb-3">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-sm font-medium text-gray-700">${item[0]}</span>
                                                <span class="text-sm font-bold text-green-600">$${item[1].revenue.toFixed(2)}</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-4 relative">
                                                <div class="${colors[index]} h-4 rounded-full transition-all duration-500 flex items-center justify-end pr-2" style="width: ${percentage}%">
                                                    <span class="text-xs text-white font-medium">${item[1].quantity}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('');
                            })() : '<p class="text-gray-500 text-center py-4">No sales data available</p>'}
                        </div>
                    </div>
                    
                    <!-- Category Revenue Chart -->
                    <div class="p-4 bg-white rounded-lg shadow border">
                        <h4 class="font-semibold text-gray-800 mb-4">üìà Category Revenue Chart</h4>
                        <div class="space-y-3">
                            ${topCategories.length > 0 ? (() => {
                                const maxCategoryRevenue = Math.max(...topCategories.map(cat => cat[1].revenue));
                                return topCategories.slice(0, 5).map((category, index) => {
                                    const percentage = maxCategoryRevenue > 0 ? (category[1].revenue / maxCategoryRevenue) * 100 : 0;
                                    const colors = ['bg-purple-500', 'bg-indigo-500', 'bg-pink-500', 'bg-orange-500', 'bg-teal-500'];
                                    return `
                                        <div class="mb-3">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-sm font-medium text-gray-700">${category[0]}</span>
                                                <span class="text-sm font-bold text-purple-600">$${category[1].revenue.toFixed(2)}</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-4 relative">
                                                <div class="${colors[index]} h-4 rounded-full transition-all duration-500 flex items-center justify-end pr-2" style="width: ${percentage}%">
                                                    <span class="text-xs text-white font-medium">${category[1].quantity}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('');
                            })() : '<p class="text-gray-500 text-center py-4">No category data available</p>'}
                        </div>
                    </div>
                </div>
                
                <!-- Payment Methods and Hourly Sales Charts -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <!-- Payment Methods Chart -->
                    <div class="p-4 bg-white rounded-lg shadow border">
                        <h4 class="font-semibold text-gray-800 mb-4">üí≥ Payment Methods</h4>
                        <div class="space-y-4">
                            <div class="mb-3">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="flex items-center">
                                        <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
                                        <span class="text-sm font-medium">Cash</span>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-semibold text-sm">${cashTransactions.length} (${transactions.length > 0 ? ((cashTransactions.length / transactions.length) * 100).toFixed(1) : 0}%)</div>
                                        <div class="text-xs text-gray-500">$${cashTransactions.reduce((sum, t) => sum + t.total, 0).toFixed(2)}</div>
                                    </div>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="bg-green-500 h-3 rounded-full transition-all duration-500" style="width: ${transactions.length > 0 ? (cashTransactions.length / transactions.length) * 100 : 0}%"></div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="flex items-center">
                                        <div class="w-4 h-4 bg-blue-500 rounded mr-2"></div>
                                        <span class="text-sm font-medium">QR Code</span>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-semibold text-sm">${qrTransactions.length} (${transactions.length > 0 ? ((qrTransactions.length / transactions.length) * 100).toFixed(1) : 0}%)</div>
                                        <div class="text-xs text-gray-500">$${qrTransactions.reduce((sum, t) => sum + t.total, 0).toFixed(2)}</div>
                                    </div>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="bg-blue-500 h-3 rounded-full transition-all duration-500" style="width: ${transactions.length > 0 ? (qrTransactions.length / transactions.length) * 100 : 0}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hourly Sales Chart -->
                    <div class="p-4 bg-white rounded-lg shadow border">
                        <h4 class="font-semibold text-gray-800 mb-4">‚è∞ Hourly Sales Chart</h4>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            ${peakHours.length > 0 ? (() => {
                                const maxHourlyRevenue = Math.max(...peakHours.map(hour => hour[1].revenue));
                                return peakHours.map((hour, index) => {
                                    const percentage = maxHourlyRevenue > 0 ? (hour[1].revenue / maxHourlyRevenue) * 100 : 0;
                                    const colors = ['bg-orange-500', 'bg-red-500', 'bg-yellow-500', 'bg-green-500', 'bg-blue-500'];
                                    return `
                                        <div class="mb-2">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-xs font-medium text-gray-700">${hour[0]}</span>
                                                <span class="text-xs font-bold text-orange-600">$${hour[1].revenue.toFixed(2)}</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-3">
                                                <div class="${colors[index]} h-3 rounded-full transition-all duration-500 flex items-center justify-end pr-1" style="width: ${percentage}%">
                                                    <span class="text-xs text-white font-medium">${hour[1].transactions}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('');
                            })() : '<p class="text-gray-500 text-center py-4">No hourly data available</p>'}
                        </div>
                    </div>
                </div>
                
                <!-- Top Items, Peak Hours, and Slow Sellers -->
                <div class="grid grid-cols-3 gap-6">
                    <!-- Top Selling Items -->
                    <div class="p-4 bg-white rounded-lg shadow border">
                        <h4 class="font-semibold text-gray-800 mb-4">üèÜ Top Selling Items</h4>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            ${topItems.length > 0 ? topItems.map((item, index) => `
                                <div class="flex items-center justify-between p-3 ${index === 0 ? 'bg-yellow-50 border border-yellow-200' : index % 2 === 0 ? 'bg-gray-50' : ''} rounded">
                                    <div class="flex items-center">
                                        <span class="w-8 h-8 ${index === 0 ? 'bg-yellow-400 text-yellow-900' : 'bg-blue-200 text-blue-800'} rounded-full flex items-center justify-center text-sm font-bold mr-3">
                                            ${index === 0 ? 'üëë' : index + 1}
                                        </span>
                                        <div>
                                            <div class="font-medium text-sm">${item[0]}</div>
                                            <div class="text-xs text-gray-500">${item[1].transactions} transactions</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold text-green-600">$${item[1].revenue.toFixed(2)}</div>
                                        <div class="text-xs text-gray-500">${item[1].quantity} sold</div>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-gray-500 text-center py-4">No item sales data available</p>'}
                        </div>
                    </div>
                    
                    <!-- Slow Selling Items -->
                    <div class="p-4 bg-white rounded-lg shadow border">
                        <h4 class="font-semibold text-gray-800 mb-4">üêå Slow Selling Items</h4>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            ${(() => {
                                // Get all menu items and compare with sales data
                                const allMenuItems = db.items.map(item => ({
                                    name: item.name,
                                    category: item.category,
                                    price: item.price,
                                    sold: itemSales[item.name] ? itemSales[item.name].quantity : 0,
                                    revenue: itemSales[item.name] ? itemSales[item.name].revenue : 0,
                                    transactions: itemSales[item.name] ? itemSales[item.name].transactions : 0
                                }));
                                
                                // Sort by quantity sold (ascending) to find slow sellers
                                const slowSellers = allMenuItems
                                    .sort((a, b) => a.sold - b.sold)
                                    .slice(0, 5);
                                
                                return slowSellers.length > 0 ? slowSellers.map((item, index) => `
                                    <div class="flex items-center justify-between p-3 ${item.sold === 0 ? 'bg-red-50 border border-red-200' : index % 2 === 0 ? 'bg-gray-50' : ''} rounded">
                                        <div class="flex items-center">
                                            <span class="w-8 h-8 ${item.sold === 0 ? 'bg-red-200 text-red-800' : 'bg-orange-200 text-orange-800'} rounded-full flex items-center justify-center text-sm font-bold mr-3">
                                                ${item.sold === 0 ? '‚ö†Ô∏è' : 'üêå'}
                                            </span>
                                            <div>
                                                <div class="font-medium text-sm">${item.name}</div>
                                                <div class="text-xs text-gray-500">${item.category} ‚Ä¢ $${item.price.toFixed(2)}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold ${item.sold === 0 ? 'text-red-600' : 'text-orange-600'}">
                                                ${item.sold === 0 ? 'No Sales' : item.sold + ' sold'}
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                ${item.sold === 0 ? 'Consider promotion' : '$' + item.revenue.toFixed(2)}
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-gray-500 text-center py-4">All items selling well!</p>';
                            })()}
                        </div>
                    </div>
                    
                    <!-- Peak Hours -->
                    <div class="p-4 bg-white rounded-lg shadow border">
                        <h4 class="font-semibold text-gray-800 mb-4">‚è∞ Peak Hours</h4>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            ${peakHours.length > 0 ? peakHours.map((hour, index) => `
                                <div class="flex items-center justify-between p-2 ${index % 2 === 0 ? 'bg-gray-50' : ''} rounded">
                                    <div class="flex items-center">
                                        <span class="w-6 h-6 bg-orange-200 text-orange-800 rounded-full flex items-center justify-center text-xs font-bold mr-2">${index + 1}</span>
                                        <span class="text-sm font-medium">${hour[0]}</span>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-semibold text-sm">$${hour[1].revenue.toFixed(2)}</div>
                                        <div class="text-xs text-gray-500">${hour[1].transactions} transactions</div>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-gray-500 text-center py-4">No hourly data available</p>'}
                        </div>
                    </div>
                </div>
                
                ${transactions.length === 0 ? '<div class="mt-6 p-4 bg-gray-50 rounded-lg text-center text-gray-600">No data available for the selected date range</div>' : ''}
            `;
            
            document.getElementById('reportsTable').innerHTML = dashboardHTML;
        }

        function generateItemSalesReport() {
            const paymentFilter = document.getElementById('paymentFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let transactions = db.transactions;
            
            // Filter by payment type
            if (paymentFilter !== 'all') {
                transactions = transactions.filter(t => t.paymentType === paymentFilter);
            }
            
            // Filter by date range
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                
                transactions = transactions.filter(t => {
                    const transactionDate = new Date(t.timestamp);
                    return transactionDate >= start && transactionDate <= end;
                });
            }
            
            // Analyze item sales
            const itemSales = {};
            const categorySales = {};
            let totalItemsSold = 0;
            let totalItemRevenue = 0;
            
            transactions.forEach(t => {
                t.items.forEach(item => {
                    const itemName = item.name;
                    totalItemsSold += item.quantity;
                    totalItemRevenue += item.price * item.quantity;
                    
                    if (!itemSales[itemName]) {
                        itemSales[itemName] = {
                            quantity: 0,
                            revenue: 0,
                            transactions: 0,
                            avgPrice: 0,
                            category: 'Unknown'
                        };
                    }
                    
                    itemSales[itemName].quantity += item.quantity;
                    itemSales[itemName].revenue += item.price * item.quantity;
                    itemSales[itemName].transactions += 1;
                    itemSales[itemName].avgPrice = item.price;
                    
                    // Find category for this item
                    const menuItem = db.items.find(mi => mi.name === itemName);
                    if (menuItem) {
                        itemSales[itemName].category = menuItem.category;
                        
                        if (!categorySales[menuItem.category]) {
                            categorySales[menuItem.category] = {
                                quantity: 0,
                                revenue: 0,
                                items: 0
                            };
                        }
                        categorySales[menuItem.category].quantity += item.quantity;
                        categorySales[menuItem.category].revenue += item.price * item.quantity;
                        categorySales[menuItem.category].items += 1;
                    }
                });
            });
            
            // Sort items by different criteria
            const itemsByRevenue = Object.entries(itemSales).sort((a, b) => b[1].revenue - a[1].revenue);
            const itemsByQuantity = Object.entries(itemSales).sort((a, b) => b[1].quantity - a[1].quantity);
            
            const itemReportHTML = `
                <!-- Summary Cards -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="p-4 bg-gradient-to-r from-indigo-400 to-indigo-600 text-white rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-indigo-100 text-sm">Total Items Sold</p>
                                <p class="text-2xl font-bold">${totalItemsSold}</p>
                            </div>
                            <div class="text-3xl opacity-80">üì¶</div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gradient-to-r from-green-400 to-green-600 text-white rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm">Item Revenue</p>
                                <p class="text-2xl font-bold">$${totalItemRevenue.toFixed(2)}</p>
                            </div>
                            <div class="text-3xl opacity-80">üíµ</div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gradient-to-r from-purple-400 to-purple-600 text-white rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm">Unique Items</p>
                                <p class="text-2xl font-bold">${Object.keys(itemSales).length}</p>
                            </div>
                            <div class="text-3xl opacity-80">üéØ</div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gradient-to-r from-orange-400 to-orange-600 text-white rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm">Avg Items/Transaction</p>
                                <p class="text-2xl font-bold">${transactions.length > 0 ? (totalItemsSold / transactions.length).toFixed(1) : '0.0'}</p>
                            </div>
                            <div class="text-3xl opacity-80">üìä</div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Item Sales Table -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-4">üìã Detailed Item Sales Report</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-3 py-2 text-left">Rank</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left">Item Name</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left">Category</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center">Qty Sold</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center">Transactions</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center">Unit Price</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center">Total Revenue</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center">% of Total</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center">Performance</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsByRevenue.length > 0 ? itemsByRevenue.map((item, index) => {
                                    const percentOfTotal = totalItemRevenue > 0 ? (item[1].revenue / totalItemRevenue * 100) : 0;
                                    const performanceLevel = percentOfTotal >= 20 ? 'Excellent' : percentOfTotal >= 10 ? 'Good' : percentOfTotal >= 5 ? 'Average' : 'Low';
                                    const performanceColor = percentOfTotal >= 20 ? 'text-green-600' : percentOfTotal >= 10 ? 'text-blue-600' : percentOfTotal >= 5 ? 'text-yellow-600' : 'text-red-600';
                                    
                                    return `
                                        <tr class="hover:bg-gray-50 ${index < 3 ? 'bg-yellow-50' : ''}">
                                            <td class="border border-gray-300 px-3 py-2 text-center">
                                                <span class="inline-flex items-center justify-center w-6 h-6 ${index === 0 ? 'bg-yellow-400 text-yellow-900' : index === 1 ? 'bg-gray-300 text-gray-700' : index === 2 ? 'bg-orange-300 text-orange-800' : 'bg-blue-100 text-blue-800'} rounded-full text-xs font-bold">
                                                    ${index < 3 ? (index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â') : index + 1}
                                                </span>
                                            </td>
                                            <td class="border border-gray-300 px-3 py-2 font-medium">${item[0]}</td>
                                            <td class="border border-gray-300 px-3 py-2">
                                                <span class="inline-block px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">${item[1].category}</span>
                                            </td>
                                            <td class="border border-gray-300 px-3 py-2 text-center font-semibold">${item[1].quantity}</td>
                                            <td class="border border-gray-300 px-3 py-2 text-center">${item[1].transactions}</td>
                                            <td class="border border-gray-300 px-3 py-2 text-center">$${item[1].avgPrice.toFixed(2)}</td>
                                            <td class="border border-gray-300 px-3 py-2 text-center font-bold text-green-600">$${item[1].revenue.toFixed(2)}</td>
                                            <td class="border border-gray-300 px-3 py-2 text-center">${percentOfTotal.toFixed(1)}%</td>
                                            <td class="border border-gray-300 px-3 py-2 text-center">
                                                <span class="inline-block px-2 py-1 rounded text-xs font-medium ${performanceColor.replace('text-', 'bg-').replace('-600', '-100')} ${performanceColor}">${performanceLevel}</span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('') : '<tr><td colspan="9" class="border border-gray-300 px-3 py-4 text-center text-gray-500">No item sales data available</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Category Breakdown and Analysis -->
                <div class="grid grid-cols-3 gap-6">
                    <div class="p-4 bg-white rounded-lg shadow border">
                        <h4 class="font-semibold text-gray-800 mb-4">üìä Sales by Category</h4>
                        <div class="space-y-3">
                            ${Object.entries(categorySales).length > 0 ? Object.entries(categorySales)
                                .sort((a, b) => b[1].revenue - a[1].revenue)
                                .map((category, index) => {
                                    const categoryPercent = totalItemRevenue > 0 ? (category[1].revenue / totalItemRevenue * 100) : 0;
                                    return `
                                        <div class="flex items-center justify-between p-3 ${index % 2 === 0 ? 'bg-gray-50' : ''} rounded">
                                            <div class="flex items-center">
                                                <div class="w-4 h-4 bg-gradient-to-r from-blue-400 to-purple-500 rounded mr-3"></div>
                                                <div>
                                                    <div class="font-medium text-sm">${category[0]}</div>
                                                    <div class="text-xs text-gray-500">${category[1].items} different items</div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-bold text-green-600">$${category[1].revenue.toFixed(2)}</div>
                                                <div class="text-xs text-gray-500">${category[1].quantity} sold (${categoryPercent.toFixed(1)}%)</div>
                                            </div>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-gradient-to-r from-blue-400 to-purple-500 h-2 rounded-full" style="width: ${categoryPercent}%"></div>
                                        </div>
                                    `;
                                }).join('') : '<p class="text-gray-500 text-center py-4">No category data available</p>'}
                        </div>
                    </div>
                    
                    <div class="p-4 bg-white rounded-lg shadow border">
                        <h4 class="font-semibold text-gray-800 mb-4">üî• Top Quantity Sellers</h4>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            ${itemsByQuantity.slice(0, 10).map((item, index) => `
                                <div class="flex items-center justify-between p-2 ${index % 2 === 0 ? 'bg-gray-50' : ''} rounded">
                                    <div class="flex items-center">
                                        <span class="w-6 h-6 bg-red-200 text-red-800 rounded-full flex items-center justify-center text-xs font-bold mr-2">${index + 1}</span>
                                        <div>
                                            <div class="font-medium text-sm">${item[0]}</div>
                                            <div class="text-xs text-gray-500">${item[1].category}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold text-red-600">${item[1].quantity} sold</div>
                                        <div class="text-xs text-gray-500">$${item[1].revenue.toFixed(2)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="p-4 bg-white rounded-lg shadow border">
                        <h4 class="font-semibold text-gray-800 mb-4">üêå Slow Moving Items</h4>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            ${(() => {
                                // Get all menu items and compare with sales data
                                const allMenuItems = db.items.map(item => ({
                                    name: item.name,
                                    category: item.category,
                                    price: item.price,
                                    sold: itemSales[item.name] ? itemSales[item.name].quantity : 0,
                                    revenue: itemSales[item.name] ? itemSales[item.name].revenue : 0,
                                    transactions: itemSales[item.name] ? itemSales[item.name].transactions : 0
                                }));
                                
                                // Sort by quantity sold (ascending) to find slow sellers
                                const slowSellers = allMenuItems
                                    .sort((a, b) => a.sold - b.sold)
                                    .slice(0, 8);
                                
                                return slowSellers.length > 0 ? slowSellers.map((item, index) => `
                                    <div class="flex items-center justify-between p-2 ${item.sold === 0 ? 'bg-red-50 border border-red-200' : index % 2 === 0 ? 'bg-gray-50' : ''} rounded">
                                        <div class="flex items-center">
                                            <span class="w-6 h-6 ${item.sold === 0 ? 'bg-red-200 text-red-800' : 'bg-orange-200 text-orange-800'} rounded-full flex items-center justify-center text-xs font-bold mr-2">
                                                ${item.sold === 0 ? '‚ö†Ô∏è' : 'üêå'}
                                            </span>
                                            <div>
                                                <div class="font-medium text-sm">${item.name}</div>
                                                <div class="text-xs text-gray-500">${item.category} ‚Ä¢ $${item.price.toFixed(2)}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold ${item.sold === 0 ? 'text-red-600' : 'text-orange-600'} text-sm">
                                                ${item.sold === 0 ? 'No Sales' : item.sold + ' sold'}
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                ${item.sold === 0 ? 'Needs attention' : '$' + item.revenue.toFixed(2)}
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-gray-500 text-center py-4">All items performing well!</p>';
                            })()}
                        </div>
                        
                        <!-- Slow Seller Actions -->
                        <div class="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                            <h5 class="font-medium text-yellow-800 text-sm mb-2">üí° Improvement Suggestions</h5>
                            <div class="text-xs text-yellow-700 space-y-1">
                                <p>‚Ä¢ Consider promotional pricing for slow items</p>
                                <p>‚Ä¢ Review menu placement and descriptions</p>
                                <p>‚Ä¢ Bundle slow items with popular ones</p>
                                <p>‚Ä¢ Analyze customer feedback and preferences</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${Object.keys(itemSales).length === 0 ? '<div class="mt-6 p-4 bg-gray-50 rounded-lg text-center text-gray-600">No item sales data available for the selected date range</div>' : ''}
            `;
            
            document.getElementById('reportsTable').innerHTML = itemReportHTML;
        }

        function generateTransactionReport() {
            const paymentFilter = document.getElementById('paymentFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let transactions = db.transactions;
            
            // Filter by payment type
            if (paymentFilter !== 'all') {
                transactions = transactions.filter(t => t.paymentType === paymentFilter);
            }
            
            // Filter by date range
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999); // Include full end date
                
                transactions = transactions.filter(t => {
                    const transactionDate = new Date(t.timestamp);
                    return transactionDate >= start && transactionDate <= end;
                });
            }
            
            const tableHTML = `
                <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">Transaction Report Summary</h4>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div>
                            <p class="text-blue-700">Total Transactions: <span class="font-semibold">${transactions.length}</span></p>
                            <p class="text-blue-700">Total Revenue: <span class="font-semibold">$${transactions.reduce((sum, t) => sum + t.total, 0).toFixed(2)}</span></p>
                        </div>
                        <div>
                            <p class="text-blue-700">Cash Payments: <span class="font-semibold">${transactions.filter(t => t.paymentType === 'Cash').length}</span></p>
                            <p class="text-blue-700">QR Payments: <span class="font-semibold">${transactions.filter(t => t.paymentType === 'QRCode').length}</span></p>
                        </div>
                        <div>
                            <p class="text-blue-700">Average Sale: <span class="font-semibold">$${transactions.length > 0 ? (transactions.reduce((sum, t) => sum + t.total, 0) / transactions.length).toFixed(2) : '0.00'}</span></p>
                            <p class="text-blue-700">Total Discounts: <span class="font-semibold">$${transactions.reduce((sum, t) => sum + t.discount, 0).toFixed(2)}</span></p>
                        </div>
                    </div>
                </div>
                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-4 py-2">Receipt #</th>
                            <th class="border border-gray-300 px-4 py-2">Date & Time</th>
                            <th class="border border-gray-300 px-4 py-2">Subtotal</th>
                            <th class="border border-gray-300 px-4 py-2">Discount</th>
                            <th class="border border-gray-300 px-4 py-2">Total</th>
                            <th class="border border-gray-300 px-4 py-2">Payment</th>
                            <th class="border border-gray-300 px-4 py-2">Cashier</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactions.map(t => `
                            <tr>
                                <td class="border border-gray-300 px-4 py-2 font-semibold">${t.receiptNumber}</td>
                                <td class="border border-gray-300 px-4 py-2">${new Date(t.timestamp).toLocaleDateString()}<br><span class="text-xs text-gray-500">${new Date(t.timestamp).toLocaleTimeString()}</span></td>
                                <td class="border border-gray-300 px-4 py-2">$${t.subtotal.toFixed(2)}</td>
                                <td class="border border-gray-300 px-4 py-2 text-green-600">${t.discount > 0 ? '-$' + t.discount.toFixed(2) : '-'}</td>
                                <td class="border border-gray-300 px-4 py-2 font-semibold">$${t.total.toFixed(2)}</td>
                                <td class="border border-gray-300 px-4 py-2">${t.paymentType}</td>
                                <td class="border border-gray-300 px-4 py-2">${t.cashier}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${transactions.length === 0 ? '<div class="mt-4 p-4 bg-gray-50 rounded-lg text-center text-gray-600">No transactions found for the selected criteria</div>' : ''}
            `;
            
            document.getElementById('reportsTable').innerHTML = tableHTML;
        }

        function generateSummaryReport() {
            const paymentFilter = document.getElementById('paymentFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let transactions = db.transactions;
            
            // Filter by payment type
            if (paymentFilter !== 'all') {
                transactions = transactions.filter(t => t.paymentType === paymentFilter);
            }
            
            // Filter by date range
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                
                transactions = transactions.filter(t => {
                    const transactionDate = new Date(t.timestamp);
                    return transactionDate >= start && transactionDate <= end;
                });
            }
            
            // Calculate summary data
            const totalRevenue = transactions.reduce((sum, t) => sum + t.total, 0);
            const totalSubtotal = transactions.reduce((sum, t) => sum + t.subtotal, 0);
            const totalDiscounts = transactions.reduce((sum, t) => sum + t.discount, 0);
            const cashTransactions = transactions.filter(t => t.paymentType === 'Cash');
            const qrTransactions = transactions.filter(t => t.paymentType === 'QRCode');
            
            // Item analysis
            const itemSales = {};
            const categorySales = {};
            
            transactions.forEach(t => {
                t.items.forEach(item => {
                    const itemName = item.name;
                    if (!itemSales[itemName]) {
                        itemSales[itemName] = { quantity: 0, revenue: 0 };
                    }
                    itemSales[itemName].quantity += item.quantity;
                    itemSales[itemName].revenue += item.price * item.quantity;
                    
                    // Find category for this item
                    const menuItem = db.items.find(mi => mi.name === itemName);
                    if (menuItem) {
                        const category = menuItem.category;
                        if (!categorySales[category]) {
                            categorySales[category] = { quantity: 0, revenue: 0 };
                        }
                        categorySales[category].quantity += item.quantity;
                        categorySales[category].revenue += item.price * item.quantity;
                    }
                });
            });
            
            // Sort items by revenue
            const topItems = Object.entries(itemSales)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 10);
            
            const summaryHTML = `
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <!-- Financial Summary -->
                    <div class="p-4 bg-green-50 rounded-lg">
                        <h4 class="font-semibold text-green-800 mb-3">üí∞ Financial Summary</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-green-700">Total Transactions:</span>
                                <span class="font-semibold">${transactions.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-700">Gross Revenue:</span>
                                <span class="font-semibold">$${totalSubtotal.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-700">Total Discounts:</span>
                                <span class="font-semibold text-red-600">-$${totalDiscounts.toFixed(2)}</span>
                            </div>
                            <hr class="border-green-200">
                            <div class="flex justify-between text-lg">
                                <span class="text-green-800 font-semibold">Net Revenue:</span>
                                <span class="font-bold text-green-800">$${totalRevenue.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-700">Average Sale:</span>
                                <span class="font-semibold">$${transactions.length > 0 ? (totalRevenue / transactions.length).toFixed(2) : '0.00'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Methods -->
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-3">üí≥ Payment Methods</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-blue-700">Cash Transactions:</span>
                                <span class="font-semibold">${cashTransactions.length} (${transactions.length > 0 ? ((cashTransactions.length / transactions.length) * 100).toFixed(1) : 0}%)</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-700">Cash Revenue:</span>
                                <span class="font-semibold">$${cashTransactions.reduce((sum, t) => sum + t.total, 0).toFixed(2)}</span>
                            </div>
                            <hr class="border-blue-200">
                            <div class="flex justify-between">
                                <span class="text-blue-700">QR Code Transactions:</span>
                                <span class="font-semibold">${qrTransactions.length} (${transactions.length > 0 ? ((qrTransactions.length / transactions.length) * 100).toFixed(1) : 0}%)</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-700">QR Code Revenue:</span>
                                <span class="font-semibold">$${qrTransactions.reduce((sum, t) => sum + t.total, 0).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-6">
                    <!-- Top Selling Items -->
                    <div class="p-4 bg-purple-50 rounded-lg">
                        <h4 class="font-semibold text-purple-800 mb-3">üèÜ Top Selling Items</h4>
                        <div class="space-y-2 text-sm max-h-64 overflow-y-auto">
                            ${topItems.length > 0 ? topItems.map((item, index) => `
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <span class="w-6 h-6 bg-purple-200 text-purple-800 rounded-full flex items-center justify-center text-xs font-bold mr-2">${index + 1}</span>
                                        <span class="text-purple-700">${item[0]}</span>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-semibold">$${item[1].revenue.toFixed(2)}</div>
                                        <div class="text-xs text-purple-600">${item[1].quantity} sold</div>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-purple-600">No items sold in selected period</p>'}
                        </div>
                    </div>
                    
                    <!-- Category Performance -->
                    <div class="p-4 bg-orange-50 rounded-lg">
                        <h4 class="font-semibold text-orange-800 mb-3">üìä Category Performance</h4>
                        <div class="space-y-2 text-sm max-h-64 overflow-y-auto">
                            ${Object.entries(categorySales).length > 0 ? Object.entries(categorySales)
                                .sort((a, b) => b[1].revenue - a[1].revenue)
                                .map(category => `
                                <div class="flex justify-between items-center">
                                    <span class="text-orange-700">${category[0]}</span>
                                    <div class="text-right">
                                        <div class="font-semibold">$${category[1].revenue.toFixed(2)}</div>
                                        <div class="text-xs text-orange-600">${category[1].quantity} items</div>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-orange-600">No categories found in selected period</p>'}
                        </div>
                    </div>
                </div>
                
                ${transactions.length === 0 ? '<div class="mt-6 p-4 bg-gray-50 rounded-lg text-center text-gray-600">No data available for the selected date range</div>' : ''}
            `;
            
            document.getElementById('reportsTable').innerHTML = summaryHTML;
        }

        function exportToExcel() {
            const paymentFilter = document.getElementById('paymentFilter').value;
            const reportType = document.getElementById('reportType').value;
            let transactions = db.transactions;
            
            if (paymentFilter !== 'all') {
                transactions = transactions.filter(t => t.paymentType === paymentFilter);
            }
            
            // Filter by date range if specified
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                
                transactions = transactions.filter(t => {
                    const transactionDate = new Date(t.timestamp);
                    return transactionDate >= start && transactionDate <= end;
                });
            }
            
            try {
                let exportData = [];
                let fileName = '';
                
                if (reportType === 'void') {
                    // Export void transactions
                    exportData = db.voidTransactions.map(v => ({
                        'Void Receipt #': v.receiptNumber || 'N/A',
                        'Original Receipt #': v.originalReceiptNumber || 'N/A',
                        'Date Voided': new Date(v.timestamp).toLocaleDateString(),
                        'Time Voided': new Date(v.timestamp).toLocaleTimeString(),
                        'Total Voided': v.total || 0,
                        'Voided By': v.voidedBy,
                        'Staff ID': v.voidId,
                        'Reason': v.reason || 'Manual void',
                        'Type': v.voidType || 'Manual',
                        'Notes': v.notes || ''
                    }));
                    fileName = `void_report_${new Date().toISOString().split('T')[0]}`;
                } else {
                    // Export regular transactions
                    exportData = transactions.map(t => ({
                        'Receipt Number': t.receiptNumber,
                        'Date': new Date(t.timestamp).toLocaleDateString(),
                        'Time': new Date(t.timestamp).toLocaleTimeString(),
                        'Items': t.items.map(item => `${item.name} (${item.quantity}x)`).join(', '),
                        'Subtotal': t.subtotal,
                        'Discount': t.discount,
                        'Total': t.total,
                        'Payment Type': t.paymentType,
                        'Cashier': t.cashier
                    }));
                    fileName = `sales_report_${new Date().toISOString().split('T')[0]}`;
                }
                
                // Create workbook
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, reportType === 'void' ? 'Void Report' : 'Sales Report');
                
                // Detect if running on iOS
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isIOS || isMobile) {
                    // For iOS/Mobile: Create downloadable link with multiple format options
                    showMobileExportOptions(wb, exportData, fileName);
                } else {
                    // For desktop: Direct download
                    XLSX.writeFile(wb, `${fileName}.xlsx`);
                    alert('Excel file downloaded successfully!');
                }
                
            } catch (error) {
                console.error('Export error:', error);
                // Fallback: Create CSV export
                exportToCSV(transactions, reportType);
            }
        }
        
        function showMobileExportOptions(workbook, data, fileName) {
            // Create modal for mobile export options
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-2xl w-11/12 max-w-md">
                    <h3 class="text-xl font-semibold mb-4 text-center">üìä Export Options</h3>
                    <p class="text-sm text-gray-600 mb-4 text-center">Choose your preferred export format:</p>
                    
                    <div class="space-y-3">
                        <button onclick="downloadExcelMobile('${fileName}')" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-medium">
                            üìä Download Excel (.xlsx)
                        </button>
                        <button onclick="downloadCSVMobile('${fileName}')" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-medium">
                            üìÑ Download CSV (.csv)
                        </button>
                        <button onclick="copyToClipboard()" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition font-medium">
                            üìã Copy to Clipboard
                        </button>
                        <button onclick="shareData('${fileName}')" class="w-full bg-orange-600 text-white py-3 rounded-lg hover:bg-orange-700 transition font-medium">
                            üì§ Share Data
                        </button>
                    </div>
                    
                    <button onclick="closeMobileExportModal()" class="w-full mt-4 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">
                        Cancel
                    </button>
                    
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <p class="text-xs text-blue-700 text-center">
                            üí° Tip: On iOS, use "Copy to Clipboard" then paste into Numbers or Excel app
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store data globally for mobile functions
            window.mobileExportData = data;
            window.mobileExportWorkbook = workbook;
        }
        
        function downloadExcelMobile(fileName) {
            try {
                XLSX.writeFile(window.mobileExportWorkbook, `${fileName}.xlsx`);
                alert('Excel file download started! Check your Downloads folder.');
                closeMobileExportModal();
            } catch (error) {
                alert('Excel download failed. Please try CSV format instead.');
                downloadCSVMobile(fileName);
            }
        }
        
        function downloadCSVMobile(fileName) {
            try {
                const csv = convertToCSV(window.mobileExportData);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `${fileName}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    alert('CSV file downloaded successfully!');
                    closeMobileExportModal();
                } else {
                    // Fallback for older browsers
                    copyToClipboard();
                }
            } catch (error) {
                alert('Download failed. Please try "Copy to Clipboard" option.');
                copyToClipboard();
            }
        }
        
        function copyToClipboard() {
            try {
                const csv = convertToCSV(window.mobileExportData);
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(csv).then(() => {
                        alert('‚úÖ Data copied to clipboard!\n\nYou can now paste it into:\n‚Ä¢ Numbers (iOS)\n‚Ä¢ Excel\n‚Ä¢ Google Sheets\n‚Ä¢ Any spreadsheet app');
                        closeMobileExportModal();
                    }).catch(() => {
                        fallbackCopyToClipboard(csv);
                    });
                } else {
                    fallbackCopyToClipboard(csv);
                }
            } catch (error) {
                alert('Copy failed. Please try manual export.');
            }
        }
        
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('‚úÖ Data copied to clipboard!\n\nPaste into your spreadsheet app.');
                closeMobileExportModal();
            } catch (err) {
                alert('‚ùå Copy failed. Please select and copy the data manually.');
                showDataPreview(text);
            } finally {
                document.body.removeChild(textArea);
            }
        }
        
        function shareData(fileName) {
            if (navigator.share) {
                const csv = convertToCSV(window.mobileExportData);
                const blob = new Blob([csv], { type: 'text/csv' });
                const file = new File([blob], `${fileName}.csv`, { type: 'text/csv' });
                
                navigator.share({
                    title: 'Cafe POS Report',
                    text: 'Sales report from Cafe POS',
                    files: [file]
                }).then(() => {
                    closeMobileExportModal();
                }).catch((error) => {
                    // Fallback to copy
                    copyToClipboard();
                });
            } else {
                // Fallback for browsers without Web Share API
                copyToClipboard();
            }
        }
        
        function showDataPreview(csvData) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-2xl w-11/12 max-w-4xl max-h-96 overflow-hidden">
                    <h3 class="text-xl font-semibold mb-4">üìÑ Export Data Preview</h3>
                    <p class="text-sm text-gray-600 mb-4">Select all text below and copy manually:</p>
                    <textarea class="w-full h-64 p-3 border border-gray-300 rounded-lg font-mono text-xs" readonly>${csvData}</textarea>
                    <div class="flex gap-3 mt-4">
                        <button onclick="selectAllPreview()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Select All</button>
                        <button onclick="closeDataPreview()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentPreviewModal = modal;
        }
        
        function selectAllPreview() {
            const textarea = document.querySelector('textarea');
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices
        }
        
        function closeDataPreview() {
            if (window.currentPreviewModal) {
                document.body.removeChild(window.currentPreviewModal);
                window.currentPreviewModal = null;
            }
            closeMobileExportModal();
        }
        
        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvHeaders = headers.join(',');
            
            const csvRows = data.map(row => {
                return headers.map(header => {
                    const value = row[header];
                    // Escape commas and quotes in CSV
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',');
            });
            
            return [csvHeaders, ...csvRows].join('\n');
        }
        
        function closeMobileExportModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (modal) {
                document.body.removeChild(modal);
            }
            // Clean up global variables
            window.mobileExportData = null;
            window.mobileExportWorkbook = null;
        }
        
        function exportToCSV(transactions, reportType) {
            // Fallback CSV export function
            let csvData = '';
            
            if (reportType === 'void') {
                csvData = convertToCSV(db.voidTransactions.map(v => ({
                    'Void Receipt #': v.receiptNumber || 'N/A',
                    'Original Receipt #': v.originalReceiptNumber || 'N/A',
                    'Date Voided': new Date(v.timestamp).toLocaleDateString(),
                    'Time Voided': new Date(v.timestamp).toLocaleTimeString(),
                    'Total Voided': v.total || 0,
                    'Voided By': v.voidedBy,
                    'Reason': v.reason || 'Manual void'
                })));
            } else {
                csvData = convertToCSV(transactions.map(t => ({
                    'Receipt Number': t.receiptNumber,
                    'Date': new Date(t.timestamp).toLocaleDateString(),
                    'Time': new Date(t.timestamp).toLocaleTimeString(),
                    'Subtotal': t.subtotal,
                    'Discount': t.discount,
                    'Total': t.total,
                    'Payment Type': t.paymentType,
                    'Cashier': t.cashier
                })));
            }
            
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${reportType}_report_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('CSV file downloaded as fallback!');
        }

        function showVoidReport() {
            const voidTableHTML = `
                <table class="w-full border-collapse border border-gray-300 text-sm">
                    <thead>
                        <tr class="bg-red-100">
                            <th class="border border-gray-300 px-2 py-2">Void Receipt #</th>
                            <th class="border border-gray-300 px-2 py-2">Original Receipt #</th>
                            <th class="border border-gray-300 px-2 py-2">Date Voided</th>
                            <th class="border border-gray-300 px-2 py-2">Total Voided</th>
                            <th class="border border-gray-300 px-2 py-2">Voided By</th>
                            <th class="border border-gray-300 px-2 py-2">Staff ID</th>
                            <th class="border border-gray-300 px-2 py-2">Reason</th>
                            <th class="border border-gray-300 px-2 py-2">Type</th>
                            <th class="border border-gray-300 px-2 py-2">Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${db.voidTransactions.map(v => `
                            <tr>
                                <td class="border border-gray-300 px-2 py-2 font-semibold text-red-600">${v.receiptNumber || 'N/A'}</td>
                                <td class="border border-gray-300 px-2 py-2 font-semibold">${v.originalReceiptNumber || 'N/A'}</td>
                                <td class="border border-gray-300 px-2 py-2">${new Date(v.timestamp).toLocaleDateString()}<br><span class="text-xs text-gray-500">${new Date(v.timestamp).toLocaleTimeString()}</span></td>
                                <td class="border border-gray-300 px-2 py-2 text-red-600 font-semibold">$${(v.total || 0).toFixed(2)}</td>
                                <td class="border border-gray-300 px-2 py-2">${v.voidedBy}</td>
                                <td class="border border-gray-300 px-2 py-2">${v.voidId}</td>
                                <td class="border border-gray-300 px-2 py-2">
                                    <span class="inline-block px-2 py-1 rounded text-xs font-medium ${getReasonColor(v.reason || 'Manual void')}">${v.reason || 'Manual void'}</span>
                                </td>
                                <td class="border border-gray-300 px-2 py-2">
                                    <span class="inline-block px-2 py-1 rounded text-xs ${v.voidType === 'Receipt Void' ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800'}">${v.voidType || 'Manual'}</span>
                                </td>
                                <td class="border border-gray-300 px-2 py-2 text-xs">${v.notes ? `<div class="max-w-32 truncate" title="${v.notes}">${v.notes}</div>` : '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${db.voidTransactions.length > 0 ? `
                <div class="mt-4 grid grid-cols-2 gap-4">
                    <div class="p-4 bg-red-50 rounded-lg">
                        <h4 class="font-semibold text-red-800 mb-2">Void Summary</h4>
                        <p class="text-red-700 text-sm">Total Voided Transactions: ${db.voidTransactions.length}</p>
                        <p class="text-red-700 text-sm">Total Amount Voided: $${db.voidTransactions.reduce((sum, v) => sum + (v.total || 0), 0).toFixed(2)}</p>
                    </div>
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-2">Void Reasons Breakdown</h4>
                        ${getVoidReasonBreakdown()}
                    </div>
                </div>
                ` : '<div class="mt-4 p-4 bg-gray-50 rounded-lg text-center text-gray-600">No void transactions found</div>'}
            `;
            
            document.getElementById('reportsTable').innerHTML = voidTableHTML;
        }

        function getReasonColor(reason) {
            const colorMap = {
                'Customer Request': 'bg-green-100 text-green-800',
                'Wrong Order': 'bg-yellow-100 text-yellow-800',
                'Payment Issue': 'bg-red-100 text-red-800',
                'Item Unavailable': 'bg-orange-100 text-orange-800',
                'Staff Error': 'bg-purple-100 text-purple-800',
                'System Error': 'bg-red-100 text-red-800',
                'Manager Override': 'bg-blue-100 text-blue-800',
                'Refund Request': 'bg-green-100 text-green-800',
                'Duplicate Transaction': 'bg-yellow-100 text-yellow-800',
                'Manual void': 'bg-gray-100 text-gray-800'
            };
            return colorMap[reason] || 'bg-gray-100 text-gray-800';
        }

        function getVoidReasonBreakdown() {
            const reasonCounts = {};
            db.voidTransactions.forEach(v => {
                const reason = v.reason || 'Manual void';
                reasonCounts[reason] = (reasonCounts[reason] || 0) + 1;
            });
            
            return Object.entries(reasonCounts)
                .map(([reason, count]) => `<p class="text-blue-700 text-sm">${reason}: ${count}</p>`)
                .join('');
        }

        // Settings & Admin Functions
        function showSettings() {
            if (currentUser.role !== 'manager' && currentUser.role !== 'sysadmin') {
                alert('Access denied. Manager or SysAdmin privileges required.');
                return;
            }
            
            // Check license for Manager users
            if (currentUser.role === 'manager') {
                const now = new Date();
                const expiryDate = new Date(db.license.expiryDate);
                if (now > expiryDate) {
                    alert('‚ö†Ô∏è LICENSE EXPIRED\n\nManager functions are disabled due to expired license.\nPlease contact your System Administrator to extend the license.');
                    return;
                }
            }
            
            document.getElementById('settingsModal').classList.remove('hidden');
            updateSettingsModal();
        }

        function updateSettingsModal() {
            const settingsContent = document.querySelector('#settingsModal .grid');
            
            if (currentUser.role === 'sysadmin') {
                // SysAdmin sees all options including license management
                settingsContent.innerHTML = `
                    <!-- User Management -->
                    <div>
                        <h4 class="font-semibold mb-3">User Management</h4>
                        <div class="space-y-2">
                            <button onclick="showCreateUser()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">üë§ Create User</button>
                            <button onclick="showManageUsers()" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition">üóëÔ∏è Manage Users</button>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div>
                        <h4 class="font-semibold mb-3">Data Management</h4>
                        <div class="space-y-2">
                            <button onclick="backupData()" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition">üíæ Backup Data</button>
                            <button onclick="restoreData()" class="w-full bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition">üîÑ Restore Data</button>
                        </div>
                    </div>

                    <!-- License Management -->
                    <div>
                        <h4 class="font-semibold mb-3">License Management</h4>
                        <div class="space-y-2">
                            <button onclick="showLicenseInfo()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">üìã License Info</button>
                            <button onclick="showExtendLicense()" class="w-full bg-yellow-600 text-white py-2 rounded-lg hover:bg-yellow-700 transition">‚è∞ Extend License</button>
                        </div>
                    </div>

                    <!-- System Settings -->
                    <div>
                        <h4 class="font-semibold mb-3">System Settings</h4>
                        <div class="space-y-2">
                            <button onclick="showSystemConfig()" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition">‚öôÔ∏è System Config</button>
                            <button onclick="showAdvancedSettings()" class="w-full bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 transition">üîß Advanced Settings</button>
                        </div>
                    </div>
                `;
            } else if (currentUser.role === 'manager') {
                // Manager sees limited options
                settingsContent.innerHTML = `
                    <!-- User Management -->
                    <div>
                        <h4 class="font-semibold mb-3">User Management</h4>
                        <div class="space-y-2">
                            <button onclick="showCreateUser()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">üë§ Create User</button>
                            <button onclick="showManageUsers()" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition">üóëÔ∏è Manage Users</button>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div>
                        <h4 class="font-semibold mb-3">Data Management</h4>
                        <div class="space-y-2">
                            <button onclick="backupData()" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition">üíæ Backup Data</button>
                            <button onclick="restoreData()" class="w-full bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition">üîÑ Restore Data</button>
                        </div>
                    </div>
                `;
            }
        }

        function showCreateUser() {
            document.getElementById('createUserModal').classList.remove('hidden');
        }

        function showManageUsers() {
            document.getElementById('manageUsersModal').classList.remove('hidden');
            loadUsersTable();
        }

        function loadUsersTable() {
            const container = document.getElementById('usersTable');
            
            if (db.users.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No users found</p>';
                return;
            }
            
            const tableHTML = `
                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-4 py-2">ID</th>
                            <th class="border border-gray-300 px-4 py-2">Username</th>
                            <th class="border border-gray-300 px-4 py-2">Role</th>
                            <th class="border border-gray-300 px-4 py-2">Status</th>
                            <th class="border border-gray-300 px-4 py-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${db.users.map(user => `
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-300 px-4 py-2 font-mono text-sm">${user.id}</td>
                                <td class="border border-gray-300 px-4 py-2 font-semibold">${user.username}</td>
                                <td class="border border-gray-300 px-4 py-2">
                                    <span class="inline-block px-2 py-1 rounded text-xs font-medium ${
                                        user.role === 'sysadmin' ? 'bg-red-100 text-red-800' : 
                                        user.role === 'manager' ? 'bg-purple-100 text-purple-800' : 
                                        'bg-blue-100 text-blue-800'
                                    }">${user.role === 'sysadmin' ? 'SysAdmin' : user.role.charAt(0).toUpperCase() + user.role.slice(1)}</span>
                                </td>
                                <td class="border border-gray-300 px-4 py-2">
                                    <span class="inline-block px-2 py-1 rounded text-xs ${user.username === currentUser.username ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${user.username === currentUser.username ? 'Current User' : 'Active'}</span>
                                </td>
                                <td class="border border-gray-300 px-4 py-2">
                                    ${user.username === currentUser.username ? 
                                        '<span class="text-gray-500 text-sm">Cannot delete current user</span>' : 
                                        `<button onclick="deleteUser(${user.id}, '${user.username}')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition text-sm">üóëÔ∏è Delete</button>`
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">User Management Summary</h4>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div>
                            <p class="text-blue-700">Total Users: <span class="font-semibold">${db.users.length}</span></p>
                        </div>
                        <div>
                            <p class="text-blue-700">SysAdmin Users: <span class="font-semibold">${db.users.filter(u => u.role === 'sysadmin').length}</span></p>
                        </div>
                        <div>
                            <p class="text-blue-700">Manager Users: <span class="font-semibold">${db.users.filter(u => u.role === 'manager').length}</span></p>
                        </div>
                        <div>
                            <p class="text-blue-700">Staff Users: <span class="font-semibold">${db.users.filter(u => u.role === 'staff').length}</span></p>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }

        function deleteUser(userId, username) {
            // Prevent deleting current user
            if (username === currentUser.username) {
                alert('You cannot delete your own account while logged in.');
                return;
            }
            
            // Prevent deleting the last admin
            const user = db.users.find(u => u.id === userId);
            if (user.role === 'admin') {
                const adminCount = db.users.filter(u => u.role === 'admin').length;
                if (adminCount <= 1) {
                    alert('Cannot delete the last admin user. At least one admin must remain in the system.');
                    return;
                }
            }
            
            const confirmDelete = confirm(`Are you sure you want to delete user "${username}"?\n\nThis action cannot be undone and will:\n- Remove the user account permanently\n- Prevent them from logging in\n- Keep their transaction history for audit purposes`);
            
            if (confirmDelete) {
                // Remove user from database
                db.users = db.users.filter(u => u.id !== userId);
                saveToStorage('pos_users', db.users);
                
                // Reload the users table
                loadUsersTable();
                
                alert(`User "${username}" has been deleted successfully.`);
            }
        }

        document.getElementById('createUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            // Check if username already exists
            if (db.users.find(u => u.username === username)) {
                alert('Username already exists');
                return;
            }
            
            const newUser = {
                id: Date.now(),
                username: username,
                password: password,
                role: role
            };
            
            db.users.push(newUser);
            saveToStorage('pos_users', db.users);
            
            closeModal('createUserModal');
            document.getElementById('createUserForm').reset();
            alert('User created successfully');
        });



        function backupData() {
            const backupData = {
                users: db.users,
                categories: db.categories,
                items: db.items,
                transactions: db.transactions,
                voidTransactions: db.voidTransactions,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `cafe_pos_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('Backup created successfully');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const backupData = JSON.parse(e.target.result);
                            
                            // Restore data
                            db.users = backupData.users || [];
                            db.categories = backupData.categories || [];
                            db.items = backupData.items || [];
                            db.transactions = backupData.transactions || [];
                            db.voidTransactions = backupData.voidTransactions || [];
                            
                            // Save to localStorage
                            saveToStorage('pos_users', db.users);
                            saveToStorage('pos_categories', db.categories);
                            saveToStorage('pos_items', db.items);
                            saveToStorage('pos_transactions', db.transactions);
                            saveToStorage('pos_void_transactions', db.voidTransactions);
                            
                            // Refresh displays
                            loadCategories();
                            loadMenuItems();
                            
                            alert('Data restored successfully');
                        } catch (error) {
                            alert('Error restoring data: Invalid backup file');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Utility Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Event listeners for report filters
        document.getElementById('paymentFilter').addEventListener('change', generateReportsTable);
        document.getElementById('reportType').addEventListener('change', generateReportsTable);

        // Event listeners for void reason dropdowns
        document.getElementById('voidReason').addEventListener('change', function() {
            const customDiv = document.getElementById('customReasonDiv');
            if (this.value === 'Other') {
                customDiv.classList.remove('hidden');
            } else {
                customDiv.classList.add('hidden');
            }
        });

        document.getElementById('receiptVoidReason').addEventListener('change', function() {
            const customDiv = document.getElementById('receiptCustomReasonDiv');
            if (this.value === 'Other') {
                customDiv.classList.remove('hidden');
            } else {
                customDiv.classList.add('hidden');
            }
        });

        // Real-time clock and system functions
        function startRealTimeClock() {
            realTimeInterval = setInterval(() => {
                const now = new Date();
                document.getElementById('realTimeDate').textContent = now.toLocaleDateString();
                document.getElementById('realTimeTime').textContent = now.toLocaleTimeString();
            }, 1000);
        }

        function stopRealTimeClock() {
            if (realTimeInterval) {
                clearInterval(realTimeInterval);
                realTimeInterval = null;
            }
        }

        // Shift Management Functions
        function initializeShiftSystem() {
            // Initialize system settings if not exists
            if (!db.systemSettings.receiptCounter) {
                db.systemSettings = {
                    receiptCounter: 1,
                    dailyReceiptStart: 1,
                    dailyReceiptEnd: 1000,
                    lastResetDate: new Date().toDateString()
                };
                saveToStorage('pos_system_settings', db.systemSettings);
            }
            
            // Check if we need to reset receipt counter for new day
            const today = new Date().toDateString();
            if (db.systemSettings.lastResetDate !== today) {
                resetDailyReceipts();
            }
            
            receiptCounter = db.systemSettings.receiptCounter;
            updateReceiptDisplays();
            
            // Check for active shift
            const activeShift = db.shifts.find(s => s.status === 'active' && s.user === currentUser.username);
            if (activeShift) {
                currentShift = activeShift;
                updateShiftStatus();
            }
        }

        function resetDailyReceipts() {
            const today = new Date().toDateString();
            db.systemSettings.receiptCounter = db.systemSettings.dailyReceiptStart;
            db.systemSettings.lastResetDate = today;
            receiptCounter = db.systemSettings.receiptCounter;
            saveToStorage('pos_system_settings', db.systemSettings);
        }

        function showShiftManagement() {
            document.getElementById('shiftModal').classList.remove('hidden');
            updateShiftInfo();
            loadShiftHistory();
        }

        function updateShiftInfo() {
            const container = document.getElementById('currentShiftInfo');
            
            if (currentShift) {
                const shiftDuration = new Date() - new Date(currentShift.startTime);
                const hours = Math.floor(shiftDuration / (1000 * 60 * 60));
                const minutes = Math.floor((shiftDuration % (1000 * 60 * 60)) / (1000 * 60));
                
                container.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold text-purple-800 mb-2">üü¢ Active Shift</h4>
                            <p class="text-sm text-purple-700">Staff: ${currentShift.user}</p>
                            <p class="text-sm text-purple-700">Started: ${new Date(currentShift.startTime).toLocaleString()}</p>
                            <p class="text-sm text-purple-700">Duration: ${hours}h ${minutes}m</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-purple-800 mb-2">üìä Shift Stats</h4>
                            <p class="text-sm text-purple-700">Transactions: ${getShiftTransactionCount()}</p>
                            <p class="text-sm text-purple-700">Revenue: $${getShiftRevenue().toFixed(2)}</p>
                            <p class="text-sm text-purple-700">Receipts: ${currentShift.startReceiptNumber} - ${String(receiptCounter).padStart(3, '0')}</p>
                        </div>
                    </div>
                `;
                
                document.getElementById('startShiftBtn').disabled = true;
                document.getElementById('endShiftBtn').disabled = false;
            } else {
                container.innerHTML = `
                    <div class="text-center text-gray-600">
                        <h4 class="font-semibold mb-2">üî¥ No Active Shift</h4>
                        <p class="text-sm">Start a shift to begin processing transactions</p>
                    </div>
                `;
                
                document.getElementById('startShiftBtn').disabled = false;
                document.getElementById('endShiftBtn').disabled = true;
            }
        }

        function startShift() {
            if (currentShift) {
                alert('A shift is already active. Please end the current shift first.');
                return;
            }
            
            const shift = {
                id: Date.now(),
                user: currentUser.username,
                startTime: new Date().toISOString(),
                startReceiptNumber: String(receiptCounter).padStart(3, '0'),
                status: 'active',
                date: new Date().toDateString()
            };
            
            currentShift = shift;
            db.shifts.push(shift);
            saveToStorage('pos_shifts', db.shifts);
            
            updateShiftStatus();
            updateShiftInfo();
            
            alert(`Shift started successfully!\nReceipt range: ${shift.startReceiptNumber} - 1000`);
        }

        function endShift() {
            if (!currentShift) {
                alert('No active shift to end.');
                return;
            }
            
            const endTime = new Date().toISOString();
            const shiftIndex = db.shifts.findIndex(s => s.id === currentShift.id);
            
            if (shiftIndex !== -1) {
                db.shifts[shiftIndex].endTime = endTime;
                db.shifts[shiftIndex].endReceiptNumber = String(receiptCounter).padStart(3, '0');
                db.shifts[shiftIndex].status = 'completed';
                db.shifts[shiftIndex].totalTransactions = getShiftTransactionCount();
                db.shifts[shiftIndex].totalRevenue = getShiftRevenue();
                
                saveToStorage('pos_shifts', db.shifts);
            }
            
            const shiftDuration = new Date(endTime) - new Date(currentShift.startTime);
            const hours = Math.floor(shiftDuration / (1000 * 60 * 60));
            const minutes = Math.floor((shiftDuration % (1000 * 60 * 60)) / (1000 * 60));
            
            alert(`Shift ended successfully!\nDuration: ${hours}h ${minutes}m\nTransactions: ${getShiftTransactionCount()}\nRevenue: $${getShiftRevenue().toFixed(2)}`);
            
            currentShift = null;
            updateShiftStatus();
            updateShiftInfo();
        }

        function getShiftTransactionCount() {
            if (!currentShift) return 0;
            
            return db.transactions.filter(t => 
                new Date(t.timestamp) >= new Date(currentShift.startTime) &&
                t.cashier === currentShift.user
            ).length;
        }

        function getShiftRevenue() {
            if (!currentShift) return 0;
            
            return db.transactions
                .filter(t => 
                    new Date(t.timestamp) >= new Date(currentShift.startTime) &&
                    t.cashier === currentShift.user
                )
                .reduce((sum, t) => sum + t.total, 0);
        }

        function setReceiptRange() {
            const startNumber = parseInt(document.getElementById('receiptStartNumber').value);
            
            if (startNumber < 1 || startNumber > 1000) {
                alert('Receipt number must be between 1 and 1000');
                return;
            }
            
            if (currentShift) {
                alert('Cannot change receipt range during active shift');
                return;
            }
            
            receiptCounter = startNumber;
            db.systemSettings.receiptCounter = startNumber;
            db.systemSettings.dailyReceiptStart = startNumber;
            saveToStorage('pos_system_settings', db.systemSettings);
            
            updateReceiptDisplays();
            alert(`Receipt range set to ${String(startNumber).padStart(3, '0')} - 1000`);
        }

        function updateReceiptDisplays() {
            document.getElementById('receiptNumber').textContent = `Receipt #${String(receiptCounter).padStart(3, '0')}`;
            document.getElementById('currentReceiptDisplay').textContent = `#${String(receiptCounter).padStart(3, '0')}`;
            document.getElementById('receiptRangeDisplay').textContent = `${String(db.systemSettings.dailyReceiptStart).padStart(3, '0')}-1000`;
        }

        function updateShiftStatus() {
            const statusElement = document.getElementById('shiftStatus');
            
            if (currentShift) {
                statusElement.textContent = `Active Shift - ${currentShift.user}`;
                statusElement.className = 'text-xs text-green-600 font-medium';
            } else {
                statusElement.textContent = 'No Active Shift';
                statusElement.className = 'text-xs text-gray-500';
            }
        }

        function loadShiftHistory() {
            const container = document.getElementById('shiftHistory');
            const recentShifts = db.shifts
                .sort((a, b) => new Date(b.startTime) - new Date(a.startTime))
                .slice(0, 10);
            
            if (recentShifts.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No shift history available</p>';
                return;
            }
            
            const tableHTML = `
                <table class="w-full border-collapse border border-gray-300 text-sm">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-2 py-2">Date</th>
                            <th class="border border-gray-300 px-2 py-2">Staff</th>
                            <th class="border border-gray-300 px-2 py-2">Start Time</th>
                            <th class="border border-gray-300 px-2 py-2">End Time</th>
                            <th class="border border-gray-300 px-2 py-2">Duration</th>
                            <th class="border border-gray-300 px-2 py-2">Receipts</th>
                            <th class="border border-gray-300 px-2 py-2">Transactions</th>
                            <th class="border border-gray-300 px-2 py-2">Revenue</th>
                            <th class="border border-gray-300 px-2 py-2">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentShifts.map(shift => {
                            const duration = shift.endTime ? 
                                new Date(shift.endTime) - new Date(shift.startTime) : 
                                new Date() - new Date(shift.startTime);
                            const hours = Math.floor(duration / (1000 * 60 * 60));
                            const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
                            
                            return `
                                <tr>
                                    <td class="border border-gray-300 px-2 py-2">${new Date(shift.startTime).toLocaleDateString()}</td>
                                    <td class="border border-gray-300 px-2 py-2">${shift.user}</td>
                                    <td class="border border-gray-300 px-2 py-2">${new Date(shift.startTime).toLocaleTimeString()}</td>
                                    <td class="border border-gray-300 px-2 py-2">${shift.endTime ? new Date(shift.endTime).toLocaleTimeString() : 'Active'}</td>
                                    <td class="border border-gray-300 px-2 py-2">${hours}h ${minutes}m</td>
                                    <td class="border border-gray-300 px-2 py-2">${shift.startReceiptNumber}${shift.endReceiptNumber ? ' - ' + shift.endReceiptNumber : ' - Current'}</td>
                                    <td class="border border-gray-300 px-2 py-2">${shift.totalTransactions || (shift.status === 'active' ? getShiftTransactionCount() : 0)}</td>
                                    <td class="border border-gray-300 px-2 py-2">$${(shift.totalRevenue || (shift.status === 'active' ? getShiftRevenue() : 0)).toFixed(2)}</td>
                                    <td class="border border-gray-300 px-2 py-2">
                                        <span class="inline-block px-2 py-1 rounded text-xs ${shift.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${shift.status}</span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        // License Management Functions for SysAdmin
        function showLicenseInfo() {
            if (currentUser.role !== 'sysadmin') {
                alert('Access denied. SysAdmin privileges required.');
                return;
            }
            
            const now = new Date();
            const expiryDate = new Date(db.license.expiryDate);
            const daysRemaining = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
            const isExpired = now > expiryDate;
            
            document.getElementById('licenseDetails').innerHTML = `
                <div class="p-4 ${isExpired ? 'bg-red-50 border border-red-200' : daysRemaining <= 7 ? 'bg-yellow-50 border border-yellow-200' : 'bg-green-50 border border-green-200'} rounded-lg">
                    <div class="flex items-center mb-3">
                        <span class="text-2xl mr-2">${isExpired ? 'üî¥' : daysRemaining <= 7 ? '‚ö†Ô∏è' : '‚úÖ'}</span>
                        <h4 class="font-semibold ${isExpired ? 'text-red-800' : daysRemaining <= 7 ? 'text-yellow-800' : 'text-green-800'}">
                            ${isExpired ? 'License Expired' : daysRemaining <= 7 ? 'License Expiring Soon' : 'License Active'}
                        </h4>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">License Type:</span>
                            <span class="font-medium">${db.license.licenseType || 'Standard'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Expiry Date:</span>
                            <span class="font-medium">${expiryDate.toLocaleDateString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Days Remaining:</span>
                            <span class="font-medium ${isExpired ? 'text-red-600' : daysRemaining <= 7 ? 'text-yellow-600' : 'text-green-600'}">
                                ${isExpired ? 'Expired' : daysRemaining + ' days'}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Status:</span>
                            <span class="font-medium ${isExpired ? 'text-red-600' : 'text-green-600'}">
                                ${isExpired ? 'Inactive' : 'Active'}
                            </span>
                        </div>
                    </div>
                </div>
                
                ${isExpired || daysRemaining <= 7 ? `
                <div class="p-3 bg-blue-50 rounded-lg">
                    <p class="text-blue-800 text-sm">
                        <strong>üí° Need to extend your license?</strong><br>
                        Use the "Extend License" feature to add more time to your POS system.
                    </p>
                </div>
                ` : ''}
            `;
            
            document.getElementById('licenseInfoModal').classList.remove('hidden');
        }

        function showExtendLicense() {
            if (currentUser.role !== 'sysadmin') {
                alert('Access denied. SysAdmin privileges required.');
                return;
            }
            document.getElementById('extendLicenseModal').classList.remove('hidden');
        }

        function showSystemConfig() {
            alert('System Configuration panel coming soon...');
        }

        function showAdvancedSettings() {
            alert('Advanced Settings panel coming soon...');
        }

        // Event listeners for license management
        document.getElementById('extensionPeriod').addEventListener('change', function() {
            const customDiv = document.getElementById('customPeriodDiv');
            if (this.value === 'custom') {
                customDiv.classList.remove('hidden');
            } else {
                customDiv.classList.add('hidden');
            }
        });

        document.getElementById('extendLicenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const extensionPeriod = document.getElementById('extensionPeriod').value;
            const customDays = document.getElementById('customDays').value;
            const licenseKey = document.getElementById('licenseKey').value;
            
            let daysToAdd = 0;
            
            if (extensionPeriod === 'custom') {
                if (!customDays || customDays < 1) {
                    alert('Please enter a valid number of days for custom period.');
                    return;
                }
                daysToAdd = parseInt(customDays);
            } else if (extensionPeriod) {
                daysToAdd = parseInt(extensionPeriod);
            } else {
                alert('Please select an extension period.');
                return;
            }
            
            // Extend the license
            const currentExpiry = new Date(db.license.expiryDate);
            const now = new Date();
            
            // If license is expired, extend from current date, otherwise from expiry date
            const baseDate = now > currentExpiry ? now : currentExpiry;
            const newExpiryDate = new Date(baseDate);
            newExpiryDate.setDate(newExpiryDate.getDate() + daysToAdd);
            
            db.license.expiryDate = newExpiryDate.toISOString();
            db.license.isActive = true;
            if (licenseKey) {
                db.license.licenseKey = licenseKey;
            }
            
            saveToStorage('pos_license', db.license);
            
            closeModal('extendLicenseModal');
            
            // Clear form
            document.getElementById('extendLicenseForm').reset();
            document.getElementById('customPeriodDiv').classList.add('hidden');
            
            alert(`‚úÖ License Extended Successfully!\n\nNew expiry date: ${newExpiryDate.toLocaleDateString()}\nDays added: ${daysToAdd}\n\nYour POS system license has been extended.`);
        });

        // Password visibility toggle function
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('eyeIcon');
            const eyeOffIcon = document.getElementById('eyeOffIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.add('hidden');
                eyeOffIcon.classList.remove('hidden');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('hidden');
                eyeOffIcon.classList.add('hidden');
            }
        }

        // Initialize the application
        initializeDefaultData();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98056cfad3455096',t:'MTc1ODA3ODc4Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
